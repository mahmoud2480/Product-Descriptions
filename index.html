<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù… - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Cairo", system-ui, sans-serif;
      background: #f4f7fb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .login-card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
      padding: 20px 22px;
      width: 100%;
      max-width: 380px;
      text-align: center;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.2rem;
      color: #111827;
    }
    p {
      margin: 0 0 14px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    label {
      display: block;
      text-align: right;
      margin-bottom: 4px;
      font-size: 0.8rem;
      color: #374151;
    }

    .field {
      margin-bottom: 10px;
      text-align: right;
    }

    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      margin-top: 10px;
      padding: 9px 12px;
      border-radius: 999px;
      border: none;
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      background: #0d6efd;
      color: #fff;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .msg {
      margin-top: 10px;
      font-size: 0.8rem;
      min-height: 1.4em;
    }
  </style>
</head>
<body>
  <div class="login-card">
    <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù… - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
    <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</p>

    <!-- âœ… Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯Ø§Ø®Ù„ form -->
    <form id="loginForm">
      <div class="field">
        <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input id="username" type="text" autocomplete="username" required />
      </div>

      <div class="field">
        <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="password" type="password" autocomplete="current-password" required />
      </div>

      <button type="submit" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    </form>

    <div class="msg" id="loginMsg"></div>
  </div>
  <!-- âœ… Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ -->
  <script src="config.js"></script>

  <script>
    // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API Ù…Ù† config.js
    const API_URL = window.API_URL;

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¹Ø§Ù… Ù„Ù„Ù€ API
    async function callApi(action, payload) {
      if (!API_URL) {
        throw new Error("API_URL ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„Ù config.js");
      }

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload }),
      });
      const text = await res.text();
      return JSON.parse(text);
    }

    // âœ… Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function doLogin(event) {
      event.preventDefault(); // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©

      const msgEl = document.getElementById("loginMsg");
      const btn = document.getElementById("loginBtn");
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!username || !password) {
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
        return;
      }

      btn.disabled = true;
      msgEl.style.color = "#374151";
      msgEl.textContent = "Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...";

      try {
        const result = await callApi("login", { username, password });

        if (!result.success) {
          msgEl.style.color = "#b91c1c";
          msgEl.textContent = result.message || "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
          btn.disabled = false;
          return;
        }

        // ğŸ”¹ ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù (Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„ÙƒÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª)
        const user = {
          employeeCode: result.employeeCode,
          name: result.name,
          role: result.role,
          username: result.username || username
        };

        // âœ… Ø­ÙØ¸Ù‡Ø§ ÙÙŠ employeeData (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ) + taskUser (ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        localStorage.setItem("employeeData", JSON.stringify(user));
        localStorage.setItem("taskUser", JSON.stringify(user));

        msgEl.style.color = "#16a34a";
        msgEl.textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­...";

        // âœ… ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        const roleText = (result.role || "").toString().toUpperCase();

        if (roleText.includes("ADMIN")) {
          window.location.href = "admin.html";
        } else if (roleText.includes("AUDITOR")) {
          window.location.href = "auditor.html";
        } else if (roleText.includes("EVALUATOR")) {
          window.location.href = "evaluator.html";
        } else if (roleText.includes("SUPPORT")) {
          // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ ØªØ°Ù‡Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø¹Ù…
          window.location.href = "support.html";
        } else {
          // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø§Ù„Ù…ÙˆØ¸Ù
          window.location.href = "employee.html";
        }
      } catch (err) {
        console.error(err);
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.";
        btn.disabled = false;
      }
    }

    // Ø±Ø¨Ø· Ø§Ù„ÙÙˆØ±Ù… Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
    document
      .getElementById("loginForm")
      .addEventListener("submit", doLogin);
  </script>

</body>
</html>
