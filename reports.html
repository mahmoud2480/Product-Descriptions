<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© - Ø§Ù„Ù…Ù‡Ø§Ù… Ùˆ Ø§Ù„Ø¨Ù†ÙˆØ¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: "Cairo", system-ui, sans-serif;
      background: #f4f7fb;
      color: #111827;
    }
 
    header {
      background: #0d6efd;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header a {
      color: #fff;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .nav-buttons button {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      font-family: "Cairo", system-ui, sans-serif;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .nav-buttons button:hover {
      background: rgba(255, 255, 255, 0.22);
    }
    .nav-buttons button.active {
      background: #fff;
      color: #0d6efd;
    }

    main {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }
    .filters > div {
      min-width: 130px;
    }
    .filters label {
      font-size: 0.75rem;
      color: #4b5563;
    }
    .filters select,
    .filters input {
      width: 100%;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      font-size: 0.8rem;
      box-sizing: border-box;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .summary-box {
      flex: 1;
      min-width: 150px;
      background: #f9fafb;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.8rem;
      border: 1px solid #e5e7eb;
    }
    .summary-title {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .summary-value {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .summary-sub {
      font-size: 0.7rem;
      color: #6b7280;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      text-align: center;
    }
    th {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(odd) {
      background: #f9fafb;
    }
    tbody tr:hover {
      background: #e5f2ff;
    }

    .status-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .status-correct {
      background: #dcfce7;
      color: #166534;
    }
    .status-wrong {
      background: #fee2e2;
      color: #b91c1c;
    }
    .status-na {
      background: #e5e7eb;
      color: #374151;
    }

    .badge {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .table-wrapper {
      max-height: calc(100vh - 260px);
      overflow: auto;
    }

    @media (max-width: 900px) {
      .table-wrapper {
        max-height: calc(100vh - 320px);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h1>
      <div>
        <span id="userName"></span> |
        <a href="#" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <main>
    <div class="card">
      <h2>ÙÙ„Ø§ØªØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
      <div class="filters">
        <div>
          <label>Ø§Ù„Ø´Ù‡Ø±</label>
          <select id="filterMonth" onchange="applyFiltersAndRender()"></select>
        </div>
        <div>
          <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <select id="filterEmployee" onchange="applyFiltersAndRender()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        <div>
          <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
          <select id="filterCategory" onchange="applyFiltersAndRender()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        <!-- âœ… ÙÙ„ØªØ± Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø© -->
        <div>
          <label>Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø©</label>
          <select id="filterRule" onchange="applyFiltersAndRender()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        <div>
          <label>Ø­Ø§Ù„Ø© Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø©</label>
          <select id="filterStatus" onchange="applyFiltersAndRender()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="correct">âœ… ØµØ­</option>
            <option value="wrong">âŒ Ø®Ø·Ø£</option>
            <option value="na">â­• Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚</option>
          </select>
        </div>
        <div style="flex:1; min-width: 160px;">
          <label>Ø¨Ø­Ø« ÙÙŠ Ù†Øµ Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø©</label>
          <input
            type="text"
            id="filterRuleText"
            placeholder="Ù…Ø«Ø§Ù„: ØµÙˆØ±Ø©ØŒ Ø³Ø¹Ø±ØŒ Ù…ÙˆØ§ØµÙØ§Øª..."
            oninput="applyFiltersAndRender()"
          />
        </div>
      </div>

      <div class="summary-row">
        <div class="summary-box">
          <div class="summary-title">Ø¹Ø¯Ø¯ Ø£Ø³Ø·Ø± Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬ÙˆØ¯Ø© (Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©)</div>
          <div class="summary-value" id="sumRows">0</div>
          <div class="summary-sub">
            ÙƒÙ„ Ø³Ø·Ø± = Ø¨Ù†Ø¯ Ø¬ÙˆØ¯Ø© ÙˆØ§Ø­Ø¯ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø©.
          </div>
        </div>

        <div class="summary-box">
          <div class="summary-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø© / Ø§Ù„Ù…Ù…ÙƒÙ†Ø©</div>
          <div class="summary-value" id="sumPoints">0 / 0 (0%)</div>
          <div class="summary-sub">
            Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ âœ… ØµØ­ ÙÙ‚Ø·.
          </div>
        </div>

        <!-- âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© ÙÙŠ Ø§Ù„ÙØªØ±Ø© -->
        <div class="summary-box">
          <div class="summary-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø£ÙƒÙˆØ§Ø¯ Ù…Ø®ØªÙ„ÙØ©)</div>
          <div class="summary-value" id="sumProducts">0</div>
          <div class="summary-sub">
            ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ø­Ø³Ø¨ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø¶Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
          </div>
        </div>

        <!-- âœ… Ø¹Ø¯Ø¯ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© ÙÙŠ Ø§Ù„ÙØªØ±Ø© -->
        <div class="summary-box">
          <div class="summary-title">Ø¹Ø¯Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
          <div class="summary-value" id="sumCategories">0</div>
          <div class="summary-sub">
            Ø¹Ø¯Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ø¶Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
          </div>
        </div>

        <div class="summary-box">
          <div class="summary-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
          <div class="summary-value" id="sumStatus">âœ…0 | âŒ0 | â­•0</div>
          <div class="summary-sub">
            Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­Ø©/Ø§Ù„Ø®Ø§Ø·Ø¦Ø©/Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>
        Ø¬Ø¯ÙˆÙ„ ØªÙØµÙŠÙ„ÙŠ: Ø§Ù„Ù…ÙˆØ¸Ù Ã— Ø§Ù„Ù…Ù‡Ù…Ø© Ã— ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬ Ã— Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø©
      </h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#Task</th>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‡Ù…Ø©</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø©</th>
              <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody id="reportBody">
            <tr>
              <td colspan="8">...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ API -->
  <script src="config.js"></script>

  <script>
    const API_URL = window.API_URL;

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload }),
      });
      const txt = await res.text();
      return JSON.parse(txt);
    }

    let user = null;
    let allRows = []; // ÙƒÙ„ Ø£Ø³Ø·Ø± AuditDetails Ø§Ù„ØªÙŠ Ø±Ø¬Ø¹Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    function hasRole(code) {
      if (!user || !user.role) return false;

      const rolesTextUpper = user.role.toString().toUpperCase();
      const rolesTextRaw   = user.role.toString();

      if (code === "AUDITOR_EXTENDED") {
        return (
          rolesTextUpper.includes("AUDITOR") ||
          rolesTextUpper.includes("ADMIN")   ||
          rolesTextUpper.includes("MANAGER") ||
          rolesTextRaw.includes("Ù…Ø¯ÙŠØ±")     ||
          rolesTextRaw.includes("Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù…") ||
          rolesTextRaw.includes("Ù…Ø¯Ù‚Ù‚")
        );
      }

      return rolesTextUpper.includes(code);
    }

    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

      const links = [
        { code: "EMP",              label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù",   href: "employee.html" },
        { code: "EMP",              label: "Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù",   href: "ideas.html" },
        { code: "AUDITOR_EXTENDED", label: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚",    href: "auditor.html" },
        { code: "EVALUATOR",        label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",  href: "evaluator.html" },
        { code: "ADMIN",            label: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",   href: "admin.html" },
        { code: "ADMIN",            label: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±",  href: "ideas_admin.html" },
        { code: "EVALUATOR",        label: "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ", href: "tests.html" },
        { code: "SUPPORT",          label: "Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ",     href: "support.html" },
        { code: "AUDITOR_EXTENDED", label: "ØªÙ‚Ø§Ø±ÙŠØ± ",        href: "reports.html" }
      ];

      links.forEach((item) => {
        if (!hasRole(item.code)) return;
        const btn = document.createElement("button");
        btn.textContent = item.label;
        if (activeHref === item.href) btn.classList.add("active");
        btn.onclick = () => {
          if (!window.location.pathname.endsWith(item.href)) {
            window.location.href = item.href;
          }
        };
        container.appendChild(btn);
      });
    }

    function initMonthFilter() {
      const sel = document.getElementById("filterMonth");
      const now = new Date();

      sel.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±";
      sel.appendChild(allOpt);

      // Ø¢Ø®Ø± 12 Ø´Ù‡Ø± (Ø¨Ù…Ø§ ÙÙŠÙ‡Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)
      for (let i = 0; i < 12; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const y = d.getFullYear();
        const m = ("0" + (d.getMonth() + 1)).slice(-2);
        const key = y + "-" + m;
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        sel.appendChild(opt);
      }

      const currentKey =
        now.getFullYear() + "-" + ("0" + (now.getMonth() + 1)).slice(-2);
      sel.value = currentKey;
    }

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);

      // ØµÙ„Ø§Ø­ÙŠØ© ÙØªØ­ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©: Ù†ÙØ³ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ù‚Ù‚ Ø§Ù„Ù…ÙˆØ³Ø¹Ø©
      if (!hasRole("AUDITOR_EXTENDED")) {
        window.location.href = "employee.html";
        return;
      }

      document.getElementById("userName").textContent =
        user.name + " (" + user.employeeCode + ")";

      renderNav("reports.html");
      initMonthFilter();
      reloadReport();
    }

    async function reloadReport() {
      const tbody = document.getElementById("reportBody");
      tbody.innerHTML = "<tr><td colspan='8'>...Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";

      try {
        // Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ Ù†Ø·Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø·Ø± Ø¨Ø¯ÙˆÙ† ÙÙ„Ø§ØªØ± Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        const res = await callApi("getQualityReport", {
          filters: {}
        });

        if (!res.success) {
          tbody.innerHTML =
            "<tr><td colspan='8'>Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±</td></tr>";
          return;
        }

        allRows = res.rows || [];

        buildEmployeeFilterFromData();
        buildCategoryFilterFromData();
        buildRuleFilterFromData();   // âœ… ØªØ¹Ø¨Ø¦Ø© ÙÙ„ØªØ± Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø©
        applyFiltersAndRender();
      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          "<tr><td colspan='8'>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±</td></tr>";
      }
    }

    function buildEmployeeFilterFromData() {
      const sel = document.getElementById("filterEmployee");
      const oldVal = sel.value;
      const set = new Set();

      allRows.forEach((r) => {
        if (r.EmployeeCode) {
          set.add(r.EmployeeName + "|" + r.EmployeeCode);
        }
      });

      sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
      set.forEach((v) => {
        const [name, code] = v.split("|");
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = name + " (" + code + ")";
        sel.appendChild(opt);
      });

      if ([...set].some((v) => v.split("|")[1] === oldVal)) {
        sel.value = oldVal;
      }
    }

    function buildCategoryFilterFromData() {
      const sel = document.getElementById("filterCategory");
      const oldVal = sel.value;
      const set = new Set();

      allRows.forEach((r) => {
        if (r.ProductCategory) set.add(r.ProductCategory);
      });

      sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
      set.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        sel.appendChild(opt);
      });

      if (set.has(oldVal)) {
        sel.value = oldVal;
      }
    }

    // âœ… ÙÙ„ØªØ± Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø© (Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©)
    function buildRuleFilterFromData() {
      const sel = document.getElementById("filterRule");
      const oldVal = sel.value;
      const set = new Set();

      allRows.forEach((r) => {
        if (r.RuleDescription) {
          set.add(r.RuleDescription.toString());
        }
      });

      sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
      set.forEach((ruleText) => {
        const opt = document.createElement("option");
        opt.value = ruleText;
        // Ù†Ø®ØªØµØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ùˆ Ø§Ù„Ø¬Ù…Ù„Ø© Ø·ÙˆÙŠÙ„Ø©
        const display =
          ruleText.length > 70 ? ruleText.slice(0, 70) + "..." : ruleText;
        opt.textContent = display;
        sel.appendChild(opt);
      });

      if (set.has(oldVal)) {
        sel.value = oldVal;
      }
    }

 function applyFiltersAndRender() {
  const tbody = document.getElementById("reportBody");

  if (!allRows.length) {
    tbody.innerHTML =
      "<tr><td colspan='8'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>";
    updateSummary([]);
    return;
  }

  const monthKey = document.getElementById("filterMonth").value || "";
  const empCode  = document.getElementById("filterEmployee").value || "";
  const cat      = document.getElementById("filterCategory").value || "";
  const ruleVal  = document.getElementById("filterRule").value || "";
  const status   = document.getElementById("filterStatus").value || "";
  const ruleText = document
    .getElementById("filterRuleText")
    .value.toLowerCase()
    .trim();

  const filtered = allRows.filter((r) => {
    // ğŸ—“ ÙÙ„ØªØ± Ø§Ù„Ø´Ù‡Ø±: Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ MonthKey Ø«Ù… TaskDate
    if (monthKey) {
      let rowMonthKey = "";

      // 1) Ù…Ù† MonthKey Ø¥Ù† ÙˆØ¬Ø¯
      if (r.MonthKey) {
        rowMonthKey = String(r.MonthKey);
        // Ù„Ùˆ Ø§Ù„Ø´ÙƒÙ„ Ù…Ø«Ù„Ø§Ù‹ "2026-01-15" Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ 7 Ù…Ø­Ø§Ø±Ù ÙÙ‚Ø·
        if (rowMonthKey.length >= 7) {
          rowMonthKey = rowMonthKey.slice(0, 7);
        }
      }

      // 2) Ù„Ùˆ Ù…Ø§ Ø­ØµÙ„Ù†Ø§ MonthKey Ù†Ø­Ø³Ø¨Ù‡ Ù…Ù† TaskDate
      if (!rowMonthKey && r.TaskDate) {
        const d = new Date(r.TaskDate);
        if (!isNaN(d.getTime())) {
          const y = d.getFullYear();
          const m = ("0" + (d.getMonth() + 1)).slice(-2);
          rowMonthKey = y + "-" + m;
        }
      }

      if (rowMonthKey !== monthKey) return false;
    }

    // Ù…ÙˆØ¸Ù
    if (empCode && String(r.EmployeeCode || "") !== empCode) return false;

    // ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬
    if (cat && String(r.ProductCategory || "") !== cat) return false;

    // Ø¨Ù†Ø¯ Ø¬ÙˆØ¯Ø© Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if (ruleVal && String(r.RuleDescription || "") !== ruleVal) return false;

    // Ø­Ø§Ù„Ø© Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø©
    if (status && String(r.Status || "") !== status) return false;

    // Ø¨Ø­Ø« Ù†ØµÙŠ Ø¯Ø§Ø®Ù„ Ø¨Ù†Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø©
    if (ruleText) {
      const t = (r.RuleDescription || "").toString().toLowerCase();
      if (t.indexOf(ruleText) === -1) return false;
    }

    return true;
  });

  if (!filtered.length) {
    tbody.innerHTML =
      "<tr><td colspan='8'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</td></tr>";
    updateSummary([]);
    return;
  }

  tbody.innerHTML = "";

  filtered.forEach((r) => {
    const tr = document.createElement("tr");

    const d = r.TaskDate
      ? new Date(r.TaskDate).toLocaleString("ar-SY")
      : "";

    const statusClass =
      r.Status === "correct"
        ? "status-correct"
        : r.Status === "wrong"
        ? "status-wrong"
        : "status-na";

    const statusText =
      r.Status === "correct"
        ? "âœ… ØµØ­"
        : r.Status === "wrong"
        ? "âŒ Ø®Ø·Ø£"
        : "â­• Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚";

    tr.innerHTML = `
      <td>${r.TaskID || ""}</td>
      <td>${r.EmployeeName || ""} <span class="badge">${r.EmployeeCode || ""}</span></td>
      <td>${d}</td>
      <td>${r.ProductCode || ""}</td>
      <td>${r.ProductCategory || ""}</td>
      <td style="text-align:right">${r.RuleDescription || ""}</td>
      <td>${r.Points || 0}</td>
      <td>
        <span class="status-pill ${statusClass}">${statusText}</span>
      </td>
    `;
    tbody.appendChild(tr);
  });

  updateSummary(filtered);
}

    function updateSummary(rows) {
      const sumRowsEl      = document.getElementById("sumRows");
      const sumPointsEl    = document.getElementById("sumPoints");
      const sumStatusEl    = document.getElementById("sumStatus");
      const sumProductsEl  = document.getElementById("sumProducts");
      const sumCategoriesEl= document.getElementById("sumCategories");

      if (!rows || !rows.length) {
        sumRowsEl.textContent       = "0";
        sumPointsEl.textContent     = "0 / 0 (0%)";
        sumStatusEl.textContent     = "âœ…0 | âŒ0 | â­•0";
        if (sumProductsEl)   sumProductsEl.textContent   = "0";
        if (sumCategoriesEl) sumCategoriesEl.textContent = "0";
        return;
      }

      let totalRows       = rows.length;
      let totalPossible   = 0;
      let totalEarned     = 0;
      let countCorrect    = 0;
      let countWrong      = 0;
      let countNA         = 0;

      const productSet   = new Set();
      const categorySet  = new Set();

      rows.forEach((r) => {
        const pts = Number(r.Points || 0);
        if (pts > 0) {
          totalPossible += pts;
          if (r.Status === "correct") {
            totalEarned += pts;
          }
        }

        if (r.Status === "correct") countCorrect++;
        else if (r.Status === "wrong") countWrong++;
        else countNA++;

        if (r.ProductCode)     productSet.add(String(r.ProductCode));
        if (r.ProductCategory) categorySet.add(String(r.ProductCategory));
      });

      const percent =
        totalPossible > 0 ? Math.round((totalEarned / totalPossible) * 100) : 0;

      sumRowsEl.textContent = totalRows.toString();
      sumPointsEl.textContent =
        totalEarned + " / " + totalPossible + " (" + percent + "%)";
      sumStatusEl.textContent =
        "âœ…" + countCorrect + " | âŒ" + countWrong + " | â­•" + countNA;

      if (sumProductsEl) {
        sumProductsEl.textContent = productSet.size.toString();
      }
      if (sumCategoriesEl) {
        sumCategoriesEl.textContent = categorySet.size.toString();
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
