<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>واجهة الموظف - المهام</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Cairo", system-ui, sans-serif;
      background: #f4f7fb;
    }
    header {
      background: #0d6efd;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    .user { font-size: 0.9rem; }
    .user a { color:#fff; }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1.4fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    h2 {
      margin: 0 0 10px;
      font-size: 1rem;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.9rem;
    }
    textarea { min-height: 60px; resize: vertical; }
    .row { display: flex; gap: 8px; }
    .row > div { flex: 1; }

    button {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-family: inherit;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.secondary { background: #6c757d; }
    button.small { padding: 5px 8px; font-size: 0.8rem; }

    .timer-display {
      margin-top: 6px;
      font-size: 0.95rem;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }
    th, td {
      border: 1px solid #eee;
      padding: 4px 6px;
      text-align: center;
    }
    th { background: #f1f3f7; }

    .rules-search {
      display: flex;
      gap: 6px;
      margin: 6px 0;
    }
    .rules-list {
      max-height: 340px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 6px;
      font-size: 0.8rem;
    }
    .rule-item {
      border-bottom: 1px solid #f1f1f1;
      padding: 4px 0;
    }
    .rule-item:last-child { border-bottom: none; }
    .rule-title {
      font-weight: 600;
      font-size: 0.85rem;
    }
    .followup-btn {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>واجهة الموظف - إدخال المهام</h1>
    <div class="user">
      <span id="userName"></span> |
      <a href="#" onclick="logout()">تسجيل الخروج</a>
    </div>
  </header>

  <div class="layout">
    <!-- جزء إدخال المهام -->
    <div class="card">
      <h2>إدخال مهمة جديدة</h2>

      <div class="row">
        <div>
          <label>كود الموظف</label>
          <input id="empCode" disabled />
        </div>
        <div>
          <label>اسم الموظف</label>
          <input id="empName" disabled />
        </div>
      </div>

      <div class="row">
        <div>
          <label>تاريخ المهمة</label>
          <input id="taskDate" type="date" />
        </div>
        <div>
          <label>نوع المهمة</label>
          <select id="taskType" onchange="onTaskTypeChange()"></select>
        </div>
      </div>

      <label>كود المنتج</label>
      <input id="productCode" />

      <label>تصنيف المنتج</label>
      <select id="productCategory"></select>

      <div id="branchSection" style="display:none;">
        <label>عدد التفريعات</label>
        <input id="branchCount" type="number" min="0" />
      </div>

      <div id="assignedSection" style="display:none;">
        <label>وصف المهمة</label>
        <textarea id="assignedText"></textarea>
        <label>رابط المهمة</label>
        <input id="assignedLink" />
      </div>

      <!-- العداد -->
      <h2 style="margin-top:14px;">عداد وقت التنفيذ</h2>
      <div class="timer-display" id="timerDisplay">00:00</div>
      <button class="small" onclick="startTimer()">بدء</button>
      <button class="small secondary" onclick="pauseTimer()">إيقاف مؤقت</button>
      <button class="small secondary" onclick="finishTimer()">إيقاف نهائي وحفظ المهمة</button>

      <input type="hidden" id="durationMinutes" value="0" />

      <div id="saveMsg" style="margin-top:8px;font-size:0.8rem;color:#0a7;"> </div>

      <h2 style="margin-top:16px;">مهامي</h2>
      <div style="max-height:260px;overflow-y:auto;">
        <table id="tasksTable">
          <thead>
            <tr>
              <th>#</th>
              <th>تاريخ</th>
              <th>نوع</th>
              <th>كود المنتج</th>
              <th>الوقت (د)</th>
              <th>حالة التدقيق</th>
              <th>نقاط الجودة</th>
              <th>ملاحظات المدقق</th>
              <th>تنفيذ الملاحظات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- جزء لوحة القواعد والبوت -->
    <div class="card">
      <h2>لوحة القواعد / البوت</h2>
      <div class="rules-search">
        <input id="ruleQuery" placeholder="اكتب كود، فئة، أو سؤال..." />
        <button class="small" onclick="searchRulesClick()">بحث</button>
      </div>
      <div id="rulesList" class="rules-list">
        <div>اكتب عبارة في البحث لعرض القواعد.</div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwnhdLEVt4jw-qbA2_RbKoz-Iwn1wvSSLva8LZSzRm_ZzHIS2BVjkkz8jLjI6FE4gdd/exec";

  async function callApi(action, payload) {
  const res = await fetch(API_URL, {
    method: "POST",
    // مهم: نجعل النوع text/plain لتجنب طلب OPTIONS (preflight)
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action, payload })
  });

  // نقرأ الرد كنص ثم نحوله لـ JSON
  const text = await res.text();
  try {
    return JSON.parse(text);
  } catch (e) {
    console.error("خطأ في parsing JSON من السيرفر:", text, e);
    throw e;
  }
}


    let user = null;
    let timerInterval = null;
    let timerSeconds = 0;
    let timerRunning = false;

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);
      document.getElementById("userName").textContent = user.name + " (" + user.role + ")";
      document.getElementById("empCode").value = user.employeeCode;
      document.getElementById("empName").value = user.name;

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = ('0' + (today.getMonth() + 1)).slice(-2);
      const dd = ('0' + today.getDate()).slice(-2);
      document.getElementById("taskDate").value = yyyy + "-" + mm + "-" + dd;

      // تحميل أنواع المهام والتصنيفات
      callApi("getTaskMeta", {})
        .then(meta => {
          const typeSel = document.getElementById("taskType");
          meta.taskTypes.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            typeSel.appendChild(opt);
          });

          const catSel = document.getElementById("productCategory");
          meta.categories.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            catSel.appendChild(opt);
          });
        })
        .catch(console.error);

      loadEmployeeTasks();
    }

    function onTaskTypeChange() {
      const val = document.getElementById("taskType").value;
      document.getElementById("branchSection").style.display = (val === "رفع منتج") ? "block" : "none";
      document.getElementById("assignedSection").style.display = (val === "مهمة موكلة") ? "block" : "none";
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timerSeconds / 60);
      const seconds = timerSeconds % 60;
      document.getElementById("timerDisplay").textContent =
        ("0" + minutes).slice(-2) + ":" + ("0" + seconds).slice(-2);
    }

    function startTimer() {
      if (timerRunning) return;
      timerRunning = true;
      timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
      }, 1000);
    }

    function pauseTimer() {
      if (!timerRunning) return;
      timerRunning = false;
      clearInterval(timerInterval);
    }

    function finishTimer() {
      if (!timerRunning && timerSeconds === 0) {
        alert("ابدأ العداد أولاً");
        return;
      }
      pauseTimer();
      const minutes = Math.round(timerSeconds / 60);
      document.getElementById("durationMinutes").value = minutes;
      saveTask();
    }

    async function saveTask() {
      const msg = document.getElementById("saveMsg");
      msg.textContent = "...جاري حفظ المهمة";

      const obj = {
        employeeCode: user.employeeCode,
        employeeName: user.name,
        taskDate: document.getElementById("taskDate").value,
        taskType: document.getElementById("taskType").value,
        productCode: document.getElementById("productCode").value,
        productCategory: document.getElementById("productCategory").value,
        branchCount: document.getElementById("branchCount").value,
        assignedText: document.getElementById("assignedText").value,
        assignedLink: document.getElementById("assignedLink").value,
        durationMinutes: document.getElementById("durationMinutes").value
      };

      try {
        const res = await callApi("saveTask", obj);
        if (res.success) {
          msg.textContent = "تم حفظ المهمة بنجاح. رقم المهمة: " + res.taskId;
          timerSeconds = 0;
          updateTimerDisplay();
          document.getElementById("durationMinutes").value = 0;
          loadEmployeeTasks();
        } else {
          msg.textContent = "فشل حفظ المهمة";
        }
      } catch (err) {
        console.error(err);
        msg.textContent = "حدث خطأ في الحفظ";
      }
    }

    async function loadEmployeeTasks() {
      const tbody = document.querySelector("#tasksTable tbody");
      tbody.innerHTML = '<tr><td colspan="9">...جاري التحميل</td></tr>';
      try {
        const list = await callApi("getEmployeeTasks", { employeeCode: user.employeeCode });
        tbody.innerHTML = "";
        list.forEach(t => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${t.TaskID || ""}</td>
            <td>${t.TaskDate ? new Date(t.TaskDate).toLocaleDateString("ar-SY") : ""}</td>
            <td>${t.TaskType || ""}</td>
            <td>${t.ProductCode || ""}</td>
            <td>${t.DurationMinutes || ""}</td>
            <td>${t.AuditStatus || ""}</td>
            <td>${t.QualityEarned || ""}/${t.QualityPossible || ""}</td>
            <td style="max-width:160px;">${t.AuditorNotes || ""}</td>
            <td>
              <span class="followup-btn" onclick="markFollowUp(${t.TaskID}, true)">تم التنفيذ</span>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="9">خطأ في تحميل المهام</td></tr>';
      }
    }

    async function markFollowUp(taskId, done) {
      await callApi("setEmployeeFollowUp", { taskId, done });
      loadEmployeeTasks();
    }

    async function searchRulesClick() {
      const q = document.getElementById("ruleQuery").value;
      const listEl = document.getElementById("rulesList");
      listEl.innerHTML = "...بحث";
      try {
        const res = await callApi("searchRules", { query: q });
        if (!res || res.length === 0) {
          listEl.innerHTML = "<div>لا توجد قواعد مطابقة</div>";
          return;
        }
        listEl.innerHTML = "";
        res.forEach(r => {
          const div = document.createElement("div");
          div.className = "rule-item";
          div.innerHTML = `
            <div class="rule-title">${r.Title || ""}</div>
            <div>${r.Details || ""}</div>
            <div style="color:#666;font-size:0.75rem;">فئات: ${r.Categories || ""}</div>
          `;
          listEl.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        listEl.innerHTML = "<div>خطأ في البحث</div>";
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
