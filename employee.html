<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù - Ø§Ù„Ù…Ù‡Ø§Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Cairo", system-ui, sans-serif;
      background: #f4f7fb;
    }

    header {
      background: #0d6efd;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header a {
      color: #fff;
    }
    .user { font-size: 0.9rem; }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .nav-buttons button {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-family: "Cairo", system-ui, sans-serif;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .nav-buttons button:hover {
      background: rgba(255,255,255,0.25);
    }
    .nav-buttons button.active {
      background: #fff;
      color: #0d6efd;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1.4fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    h2 {
      margin: 0 0 10px;
      font-size: 1rem;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    textarea { min-height: 60px; resize: vertical; }
    .row { display: flex; gap: 8px; }
    .row > div { flex: 1; }

    button {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-family: inherit;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.secondary { background: #6c757d; }
    button.small { padding: 5px 8px; font-size: 0.8rem; }

    .current-tasks {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #eee;
      padding: 6px;
    }
    .current-task-row {
      display: grid;
      grid-template-columns: 1.1fr 1fr 1fr 0.8fr 0.7fr 1.4fr;
      gap: 4px;
      align-items: center;
      font-size: 0.8rem;
      margin-bottom: 6px;
      border-bottom: 1px dashed #eee;
      padding-bottom: 4px;
    }
    .current-task-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .task-timer {
      font-weight: 600;
    }
    .status-pill {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
    }
    .status-running { background: #e0f2fe; color: #0369a1; }
    .status-paused  { background: #fef9c3; color: #854d0e; }
    .status-new     { background: #f3f4f6; color: #4b5563; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }
    th, td {
      border: 1px solid #eee;
      padding: 4px 6px;
      text-align: center;
    }
    th { background: #f1f3f7; }

    .rules-search {
      display: flex;
      gap: 6px;
      margin: 6px 0;
    }
    .rules-list {
      max-height: 340px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 6px;
      font-size: 0.8rem;
    }
    .rule-item {
      border-bottom: 1px solid #f1f1f1;
      padding: 4px 0;
    }
    .rule-item:last-child { border-bottom: none; }
    .rule-title {
      font-weight: 600;
      font-size: 0.85rem;
    }
    .followup-btn {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h1>
      <div class="user">
        <span id="userName"></span> |
        <a href="#" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <div class="layout">
    <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù‡Ø§Ù… -->
    <div class="card">
      <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>

      <div class="row">
        <div>
          <label>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <input id="empCode" disabled />
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <input id="empName" disabled />
        </div>
      </div>

      <div class="row">
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‡Ù…Ø© (ÙŠØ·Ø¨Ù‘Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)</label>
          <input id="taskDate" type="date" />
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
          <select id="taskType" onchange="onTaskTypeChange()"></select>
        </div>
      </div>

      <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</label>
      <input id="productCode" />

      <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
      <select id="productCategory"></select>

      <div id="branchSection" style="display:none;">
        <label>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØ±ÙŠØ¹Ø§Øª</label>
        <input id="branchCount" type="number" min="0" />
      </div>

      <div id="assignedSection" style="display:none;">
        <label>ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
        <textarea id="assignedText"></textarea>
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù‡Ù…Ø©</label>
        <input id="assignedLink" />
      </div>

      <button onclick="addCurrentTask()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
      <div id="saveMsg" style="margin-top:8px;font-size:0.8rem;color:#0a7;"></div>

      <h2 style="margin-top:16px;">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù‡Ù…Ø©)</h2>
      <div class="current-tasks" id="currentTasksContainer">
        <div style="font-size:0.8rem;color:#6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ©. Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡.</div>
      </div>

      <h2 style="margin-top:18px;">ÙƒÙ„ Ù…Ù‡Ø§Ù…ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
      <div style="max-height:280px;overflow-y:auto;">
        <table id="tasksTable">
          <thead>
            <tr>
              <th>#</th>
              <th>ØªØ§Ø±ÙŠØ®</th>
              <th>Ù†ÙˆØ¹</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø§Ù„ÙˆÙ‚Øª (Ø¯)</th>
              <th>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th>
              <th>Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯Ù‚Ù‚</th>
              <th>ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ / Ø§Ù„Ø¨ÙˆØª -->
    <div class="card">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ / Ø§Ù„Ø¨ÙˆØª</h2>
      <div class="rules-search">
        <input id="ruleQuery" placeholder="Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ØŒ ÙØ¦Ø©ØŒ Ø£Ùˆ Ø³Ø¤Ø§Ù„..." />
        <button class="small" onclick="searchRulesClick()">Ø¨Ø­Ø«</button>
      </div>
      <div id="rulesList" class="rules-list">
        <div>Ø§ÙƒØªØ¨ Ø¹Ø¨Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯.</div>
      </div>
    </div>
  </div>

  <script>
    // âœ… Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API Ø§Ù„ØµØ­ÙŠØ­
    const API_URL =
      "https://script.google.com/macros/s/AKfycbwack6uFyrJQhcaJ_DzX9MKfnetBIRZw-k_C0JX2ME3f8Kust45s1czKY_RCtp5kEzw/exec";

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload })
      });
      const text = await res.text();
      return JSON.parse(text);
    }

    let user = null;

    // Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø´ÙŠØª)
    let currentTasks = [];   // {id, fields..., seconds, running, status}
    let nextLocalId = 1;
    let tickInterval = null;

    function startTickLoop() {
      if (tickInterval) return;
      tickInterval = setInterval(() => {
        let changed = false;
        currentTasks.forEach(t => {
          if (t.running) {
            t.seconds++;
            changed = true;
          }
        });
        if (changed) renderCurrentTasks();
      }, 1000);
    }

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    // --- Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØªÙ†Ù‚Ù„ ---
    function hasRole(code) {
      if (!user || !user.role) return false;
      const rolesText = user.role.toString().toUpperCase();
      return rolesText.includes(code);
    }

    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

      const links = [
        { code: "EMP",       label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù",   href: "employee.html" },
        { code: "EMP",       label: "Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù",   href: "ideas.html" },
        { code: "AUDITOR",   label: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚",   href: "auditor.html" },
        { code: "EVALUATOR", label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…", href: "evaluator.html" },
        { code: "ADMIN",     label: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",  href: "admin.html" },
        { code: "ADMIN",     label: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±", href: "ideas_admin.html" }
      ];

      links.forEach(item => {
        if (!hasRole(item.code)) return;
        const btn = document.createElement("button");
        btn.textContent = item.label;
        if (activeHref === item.href) btn.classList.add("active");
        btn.onclick = () => {
          if (!window.location.pathname.endsWith(item.href)) {
            window.location.href = item.href;
          }
        };
        container.appendChild(btn);
      });
    }
    // ----------------------

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);
      document.getElementById("userName").textContent =
        user.name + " (" + user.role + ")";
      document.getElementById("empCode").value = user.employeeCode;
      document.getElementById("empName").value = user.name;

      renderNav("employee.html");

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = ('0' + (today.getMonth() + 1)).slice(-2);
      const dd = ('0' + today.getDate()).slice(-2);
      document.getElementById("taskDate").value = yyyy + "-" + mm + "-" + dd;

      callApi("getTaskMeta", {})
        .then(meta => {
          const typeSel = document.getElementById("taskType");
          meta.taskTypes.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            typeSel.appendChild(opt);
          });

          const catSel = document.getElementById("productCategory");
          meta.categories.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            catSel.appendChild(opt);
          });
        })
        .catch(console.error);

      loadEmployeeTasks();
      startTickLoop();
    }

    function onTaskTypeChange() {
      const val = document.getElementById("taskType").value;
      document.getElementById("branchSection").style.display =
        (val === "Ø±ÙØ¹ Ù…Ù†ØªØ¬") ? "block" : "none";
      document.getElementById("assignedSection").style.display =
        (val === "Ù…Ù‡Ù…Ø© Ù…ÙˆÙƒÙ„Ø©") ? "block" : "none";
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©)
    function addCurrentTask() {
      const msg = document.getElementById("saveMsg");
      msg.textContent = "";

      const taskType = document.getElementById("taskType").value;
      const productCode = document.getElementById("productCode").value.trim();
      const productCategory = document.getElementById("productCategory").value;
      const branchCount = document.getElementById("branchCount").value;
      const assignedText = document.getElementById("assignedText").value;
      const assignedLink = document.getElementById("assignedLink").value;
      const taskDate = document.getElementById("taskDate").value;

      if (!taskType) {
        msg.textContent = "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©";
        return;
      }
      if (taskType === "Ø±ÙØ¹ Ù…Ù†ØªØ¬" && !productCode) {
        msg.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù…Ù‡Ù…Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬";
        return;
      }

      const obj = {
        id: nextLocalId++,
        employeeCode: user.employeeCode,
        employeeName: user.name,
        taskDate,
        taskType,
        productCode,
        productCategory,
        branchCount,
        assignedText,
        assignedLink,
        seconds: 0,
        running: true,       // ğŸ‘ˆ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©
        status: "running"    // Ø­Ø§Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
      };

      currentTasks.push(obj);
      renderCurrentTasks();

      // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù‡Ù…Ø© (Ù„ÙƒÙ† Ù†ØªØ±Ùƒ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©)
      document.getElementById("productCode").value = "";
      document.getElementById("branchCount").value = "";
      document.getElementById("assignedText").value = "";
      document.getElementById("assignedLink").value = "";
      msg.textContent = "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.";
    }

    function formatSeconds(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return ("0" + m).slice(-2) + ":" + ("0" + s).slice(-2);
    }

    function renderCurrentTasks() {
      const container = document.getElementById("currentTasksContainer");
      if (!currentTasks.length) {
        container.innerHTML =
          '<div style="font-size:0.8rem;color:#6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ©. Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡.</div>';
        return;
      }
      container.innerHTML = "";

      currentTasks.forEach(t => {
        const row = document.createElement("div");
        row.className = "current-task-row";

        let statusText = "Ù„Ù… ØªØ¨Ø¯Ø£";
        let statusClass = "status-new";
        if (t.status === "running") {
          statusText = "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°";
          statusClass = "status-running";
        } else if (t.status === "paused") {
          statusText = "Ù…ØªÙˆÙ‚ÙØ© Ù…Ø¤Ù‚ØªØ§Ù‹";
          statusClass = "status-paused";
        }

        row.innerHTML = `
          <div><strong>${t.taskType}</strong><br/><span style="color:#6b7280;">${t.productCode || t.assignedText || ""}</span></div>
          <div>${t.productCategory || "-"}</div>
          <div class="task-timer">${formatSeconds(t.seconds)}</div>
          <div><span class="status-pill ${statusClass}">${statusText}</span></div>
          <div>
            <button class="small" onclick="startTask(${t.id})">Ø¨Ø¯Ø¡/Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
            <button class="small secondary" onclick="pauseTask(${t.id})">Ø¥ÙŠÙ‚Ø§Ù</button>
          </div>
          <div>
            <button class="small secondary" onclick="finishTask(${t.id})">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­ÙØ¸</button>
          </div>
        `;
        container.appendChild(row);
      });
    }

    function startTask(id) {
      const t = currentTasks.find(x => x.id === id);
      if (!t) return;
      t.running = true;
      t.status = "running";
      renderCurrentTasks();
    }

    function pauseTask(id) {
      const t = currentTasks.find(x => x.id === id);
      if (!t) return;
      t.running = false;
      if (t.seconds === 0) {
        t.status = "new";
      } else {
        t.status = "paused";
      }
      renderCurrentTasks();
    }

    async function finishTask(id) {
      const tIndex = currentTasks.findIndex(x => x.id === id);
      if (tIndex === -1) return;
      const t = currentTasks[tIndex];

      if (t.seconds === 0) {
        if (!confirm("Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©. Ø­ÙØ¸Ù‡Ø§ Ø¨ÙˆÙ‚Øª 0 Ø¯Ù‚ÙŠÙ‚Ø©ØŸ")) {
          return;
        }
      }
      t.running = false;
      t.status = "paused";

      const minutes = Math.round(t.seconds / 60);

      const msg = document.getElementById("saveMsg");
      msg.textContent = "...Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©";

      const payload = {
        employeeCode: t.employeeCode,
        employeeName: t.employeeName,
        taskDate: t.taskDate,
        taskType: t.taskType,
        productCode: t.productCode,
        productCategory: t.productCategory,
        branchCount: t.branchCount,
        assignedText: t.assignedText,
        assignedLink: t.assignedLink,
        durationMinutes: minutes
      };

      try {
        const res = await callApi("saveTask", payload);
        if (res.success) {
          msg.textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­. Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù…Ø©: " + res.taskId;
          currentTasks.splice(tIndex, 1);
          renderCurrentTasks();
          loadEmployeeTasks();
        } else {
          msg.textContent = "ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©";
        }
      } catch (err) {
        console.error(err);
        msg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©";
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª
    async function loadEmployeeTasks() {
      const tbody = document.querySelector("#tasksTable tbody");
      tbody.innerHTML = '<tr><td colspan="9">...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
      try {
        const list = await callApi("getEmployeeTasks", {
          employeeCode: user.employeeCode
        });
        tbody.innerHTML = "";
        if (!list || !list.length) {
          tbody.innerHTML =
            '<tr><td colspan="9">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</td></tr>';
          return;
        }
        list.forEach(t => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${t.TaskID || ""}</td>
            <td>${t.TaskDate ? new Date(t.TaskDate).toLocaleDateString("ar-SY") : ""}</td>
            <td>${t.TaskType || ""}</td>
            <td>${t.ProductCode || ""}</td>
            <td>${t.DurationMinutes || ""}</td>
            <td>${t.AuditStatus || ""}</td>
            <td>${t.QualityEarned || ""}/${t.QualityPossible || ""}</td>
            <td style="max-width:160px;">${t.AuditorNotes || ""}</td>
            <td>
              <span class="followup-btn" onclick="markFollowUp(${t.TaskID}, true)">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</span>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          '<tr><td colspan="9">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…</td></tr>';
      }
    }

    async function markFollowUp(taskId, done) {
      await callApi("setEmployeeFollowUp", { taskId, done });
      loadEmployeeTasks();
    }

    // ğŸ” Ø¨Ø­Ø« Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ + ÙˆØ±Ù‚Ø© war Ø¨Ù†ÙØ³ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«
    async function searchRulesClick() {
      const q = document.getElementById("ruleQuery").value.trim();
      const listEl = document.getElementById("rulesList");
      if (!q) {
        listEl.innerHTML = "<div>Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø£Ùˆ Ø¹Ø¨Ø§Ø±Ø© Ù„Ù„Ø¨Ø­Ø«.</div>";
        return;
      }

      listEl.innerHTML = "...Ø¨Ø­Ø«";

      try {
        // Ù†Ø¹Ù…Ù„ Ø§Ù„Ø·Ù„Ø¨ÙŠÙ† Ù…Ø¹Ø§Ù‹: Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ + Ø´ÙŠØª war
        const [rulesRes, warRes] = await Promise.all([
          callApi("searchRules", { query: q }),
          callApi("searchWar", { code: q })
        ]);

        const rules = Array.isArray(rulesRes) ? rulesRes : [];
        const war = warRes || {};

        const hasWarehouse = war.warehouse != null;
        const hasSupplier  = war.supplier  != null;
        const hasQuantity  = war.quantity  != null;

        if (!rules.length && !hasWarehouse && !hasSupplier && !hasQuantity) {
          listEl.innerHTML = "<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø­Ø«.</div>";
          return;
        }

        let html = "";

        // 1) Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯
        if (rules.length) {
          html += `<div style="margin-bottom:8px;font-weight:600;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯:</div>`;
          rules.forEach(r => {
            html += `
              <div class="rule-item">
                <div class="rule-title">${r.Title || ""}</div>
                <div>${r.Details || ""}</div>
                <div style="color:#666;font-size:0.75rem;">ÙØ¦Ø§Øª: ${r.Categories || ""}</div>
              </div>
            `;
          });
          html += `<hr/>`;
        }

        // 2) Warehouse Ù…Ù† ÙˆØ±Ù‚Ø© war
        if (hasWarehouse) {
          const w = war.warehouse;
          html += `
            <div style="margin-bottom:6px;font-weight:600;">Ø§Ù„Ù€ Warehouse (Ù…Ù† ÙˆØ±Ù‚Ø© war):</div>
            <div class="rule-item">
              <div><strong>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${w.code || ""}</div>
              <div><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${w.status || ""}</div>
              <div><strong>Ø§Ù„Ø±Ù:</strong> ${w.shelf || ""}</div>
              <div><strong>Ø§Ù„ØªØ®Ø²ÙŠÙ†:</strong> ${w.storage || ""}</div>
              <div><strong>Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø«Ø§Ù†ÙŠ:</strong> ${w.storage2 || ""}</div>
              <div><strong>ÙƒÙ…ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù:</strong> ${w.shelfAddedQty || ""}</div>
              <div><strong>ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†:</strong> ${w.storageQty || ""}</div>
              <div><strong>ØªØ­Ù‚Ù‚:</strong> ${w.check || ""}</div>
              <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${w.employee || ""}</div>
              <div><strong>Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ:</strong> ${w.timestamp || ""}</div>
            </div>
            <hr/>
          `;
        }

        // 3) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
        if (hasSupplier) {
          const s = war.supplier;
          html += `
            <div style="margin-bottom:6px;font-weight:600;">Ø§Ù„Ù…ÙˆØ±Ø¯ (Ù…Ù† ÙˆØ±Ù‚Ø© war):</div>
            <div class="rule-item">
              <div><strong>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${s.code || ""}</div>
              <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${s.supplierName || ""}</div>
              <div><strong>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø´Ø±Ø§Ø¡:</strong> ${s.lastPurchaseDate || ""}</div>
              <div><strong>ÙƒÙ„ÙØ© Ø¢Ø®Ø± Ø´Ø±Ø§Ø¡:</strong> ${s.lastPurchaseCost || ""}</div>
            </div>
            <hr/>
          `;
        }

        // 4) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ©
        if (hasQuantity) {
          const qd = war.quantity;
          html += `
            <div style="margin-bottom:6px;font-weight:600;">Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ù† ÙˆØ±Ù‚Ø© war):</div>
            <div class="rule-item">
              <div><strong>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${qd.code || ""}</div>
              <div><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> ${qd.qty || ""}</div>
              <div><strong>Ø§Ù„ØªÙƒÙ„ÙØ©:</strong> ${qd.cost || ""}</div>
            </div>
          `;
        }

        listEl.innerHTML = html;

      } catch (err) {
        console.error(err);
        listEl.innerHTML = "<div>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>";
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
