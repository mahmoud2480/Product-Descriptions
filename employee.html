<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>واجهة الموظف - المهام</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Cairo", system-ui, sans-serif;
      background: #f4f7fb;
    }

    header {
      background: #0d6efd;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header a {
      color: #fff;
    }
    .user { font-size: 0.9rem; }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .nav-buttons button {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-family: "Cairo", system-ui, sans-serif;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .nav-buttons button:hover {
      background: rgba(255,255,255,0.25);
    }
    .nav-buttons button.active {
      background: #fff;
      color: #0d6efd;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1.4fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    h2 {
      margin: 0 0 10px;
      font-size: 1rem;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.9rem;
    }
    textarea { min-height: 60px; resize: vertical; }
    .row { display: flex; gap: 8px; }
    .row > div { flex: 1; }

    button {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-family: inherit;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.secondary { background: #6c757d; }
    button.small { padding: 5px 8px; font-size: 0.8rem; }

    .current-tasks {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #eee;
      padding: 6px;
    }
    .current-task-row {
      display: grid;
      grid-template-columns: 1.1fr 1fr 1fr 0.8fr 0.7fr 1.4fr;
      gap: 4px;
      align-items: center;
      font-size: 0.8rem;
      margin-bottom: 6px;
      border-bottom: 1px dashed #eee;
      padding-bottom: 4px;
    }
    .current-task-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .task-timer {
      font-weight: 600;
    }
    .status-pill {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
    }
    .status-running { background: #e0f2fe; color: #0369a1; }
    .status-paused  { background: #fef9c3; color: #854d0e; }
    .status-new     { background: #f3f4f6; color: #4b5563; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }
    th, td {
      border: 1px solid #eee;
      padding: 4px 6px;
      text-align: center;
    }
    th { background: #f1f3f7; }

    .rules-search {
      display: flex;
      gap: 6px;
      margin: 6px 0;
    }
    .rules-list {
      max-height: 340px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 6px;
      font-size: 0.8rem;
    }
    .rule-item {
      border-bottom: 1px solid #f1f1f1;
      padding: 4px 0;
    }
    .rule-item:last-child { border-bottom: none; }
    .rule-title {
      font-weight: 600;
      font-size: 0.85rem;
    }
    .followup-btn {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>واجهة الموظف - إدارة المهام</h1>
      <div class="user">
        <span id="userName"></span> |
        <a href="#" onclick="logout()">تسجيل الخروج</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <div class="layout">
    <!-- عمود المهام -->
    <div class="card">
      <h2>إضافة مهمة جديدة إلى قائمة المهام الحالية</h2>

      <div class="row">
        <div>
          <label>كود الموظف</label>
          <input id="empCode" disabled />
        </div>
        <div>
          <label>اسم الموظف</label>
          <input id="empName" disabled />
        </div>
      </div>

      <div class="row">
        <div>
          <label>تاريخ المهمة (يطبّق على المهام الجديدة)</label>
          <input id="taskDate" type="date" />
        </div>
        <div>
          <label>نوع المهمة</label>
          <select id="taskType" onchange="onTaskTypeChange()"></select>
        </div>
      </div>

      <label>كود المنتج</label>
      <input id="productCode" />

      <label>تصنيف المنتج</label>
      <select id="productCategory"></select>

      <div id="branchSection" style="display:none;">
        <label>عدد التفريعات</label>
        <input id="branchCount" type="number" min="0" />
      </div>

      <div id="assignedSection" style="display:none;">
        <label>وصف المهمة</label>
        <textarea id="assignedText"></textarea>
        <label>رابط المهمة</label>
        <input id="assignedLink" />
      </div>

      <button onclick="addCurrentTask()">إضافة المهمة إلى قائمة المهام الحالية</button>
      <div id="saveMsg" style="margin-top:8px;font-size:0.8rem;color:#0a7;"></div>

      <h2 style="margin-top:16px;">المهام الحالية (يمكن تشغيل أكثر من مهمة)</h2>
      <div class="current-tasks" id="currentTasksContainer">
        <div style="font-size:0.8rem;color:#6b7280;">لا توجد مهام حالية. أضف مهمة جديدة من النموذج أعلاه.</div>
      </div>

      <h2 style="margin-top:18px;">كل مهامي السابقة</h2>
      <div style="max-height:280px;overflow-y:auto;">
        <table id="tasksTable">
          <thead>
            <tr>
              <th>#</th>
              <th>تاريخ</th>
              <th>نوع</th>
              <th>كود المنتج</th>
              <th>الوقت (د)</th>
              <th>حالة التدقيق</th>
              <th>نقاط الجودة</th>
              <th>ملاحظات المدقق</th>
              <th>تنفيذ الملاحظات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- عمود القواعد / البوت -->
    <div class="card">
      <h2>لوحة القواعد / البوت</h2>
      <div class="rules-search">
        <input id="ruleQuery" placeholder="اكتب كود، فئة، أو سؤال..." />
        <button class="small" onclick="searchRulesClick()">بحث</button>
      </div>
      <div id="rulesList" class="rules-list">
        <div>اكتب عبارة في البحث لعرض القواعد.</div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzun10zsjO4I2xhhvo_j09n9QL6Y_q0ssJ9wisGfK7f1Q8ORcbEe3vjqYCZ5MSDp_3I/exec";

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload })
      });
      const text = await res.text();
      return JSON.parse(text);
    }

    let user = null;

    // مهام الجلسة الحالية (قبل الحفظ في الشيت)
    let currentTasks = [];   // {id, fields..., seconds, running, status}
    let nextLocalId = 1;
    let tickInterval = null;

    function startTickLoop() {
      if (tickInterval) return;
      tickInterval = setInterval(() => {
        let changed = false;
        currentTasks.forEach(t => {
          if (t.running) {
            t.seconds++;
            changed = true;
          }
        });
        if (changed) renderCurrentTasks();
      }, 1000);
    }

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    // --- الأدوار والتنقل ---
    function hasRole(code) {
      if (!user || !user.role) return false;
      const rolesText = user.role.toString().toUpperCase();
      return rolesText.includes(code);
    }

    function renderNav(activeCode) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

      const links = [
        { code: "EMP",       label: "واجهة الموظف",   href: "employee.html" },
        { code: "AUDITOR",   label: "لوحة المدقق",   href: "auditor.html" },
        { code: "EVALUATOR", label: "واجهة التقييم", href: "evaluator.html" },
        { code: "ADMIN",     label: "لوحة الإدارة",  href: "admin.html" }
      ];

      links.forEach(item => {
        if (hasRole(item.code)) {
          const btn = document.createElement("button");
          btn.textContent = item.label;
          if (activeCode === item.code) btn.classList.add("active");
          btn.onclick = () => {
            if (window.location.pathname.endsWith(item.href)) return;
            window.location.href = item.href;
          };
          container.appendChild(btn);
        }
      });
    }
    // ----------------------

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);
      document.getElementById("userName").textContent = user.name + " (" + user.role + ")";
      document.getElementById("empCode").value = user.employeeCode;
      document.getElementById("empName").value = user.name;

      renderNav("EMP");

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = ('0' + (today.getMonth() + 1)).slice(-2);
      const dd = ('0' + today.getDate()).slice(-2);
      document.getElementById("taskDate").value = yyyy + "-" + mm + "-" + dd;

      callApi("getTaskMeta", {})
        .then(meta => {
          const typeSel = document.getElementById("taskType");
          meta.taskTypes.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            typeSel.appendChild(opt);
          });

          const catSel = document.getElementById("productCategory");
          meta.categories.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            catSel.appendChild(opt);
          });
        })
        .catch(console.error);

      loadEmployeeTasks();
      startTickLoop();
    }

    function onTaskTypeChange() {
      const val = document.getElementById("taskType").value;
      document.getElementById("branchSection").style.display = (val === "رفع منتج") ? "block" : "none";
      document.getElementById("assignedSection").style.display = (val === "مهمة موكلة") ? "block" : "none";
    }

    // إضافة مهمة جديدة إلى قائمة المهام الحالية (بدون حفظ في الشيت بعد)
    function addCurrentTask() {
      const msg = document.getElementById("saveMsg");
      msg.textContent = "";

      const taskType = document.getElementById("taskType").value;
      const productCode = document.getElementById("productCode").value.trim();
      const productCategory = document.getElementById("productCategory").value;
      const branchCount = document.getElementById("branchCount").value;
      const assignedText = document.getElementById("assignedText").value;
      const assignedLink = document.getElementById("assignedLink").value;
      const taskDate = document.getElementById("taskDate").value;

      if (!taskType) {
        msg.textContent = "يرجى اختيار نوع المهمة";
        return;
      }
      if (taskType === "رفع منتج" && !productCode) {
        msg.textContent = "يرجى إدخال كود المنتج لمهمة رفع المنتج";
        return;
      }

      const obj = {
        id: nextLocalId++,
        employeeCode: user.employeeCode,
        employeeName: user.name,
        taskDate,
        taskType,
        productCode,
        productCategory,
        branchCount,
        assignedText,
        assignedLink,
        seconds: 0,
        running: false,
        status: "new"   // new / running / paused
      };
      currentTasks.push(obj);
      renderCurrentTasks();

      // تفريغ الحقول الخاصة بالمهمة (لكن نترك التاريخ ونوع المهمة)
      document.getElementById("productCode").value = "";
      document.getElementById("branchCount").value = "";
      document.getElementById("assignedText").value = "";
      document.getElementById("assignedLink").value = "";
      msg.textContent = "تمت إضافة المهمة إلى قائمة المهام الحالية.";
    }

    function formatSeconds(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return ("0" + m).slice(-2) + ":" + ("0" + s).slice(-2);
    }

    function renderCurrentTasks() {
      const container = document.getElementById("currentTasksContainer");
      if (!currentTasks.length) {
        container.innerHTML = '<div style="font-size:0.8rem;color:#6b7280;">لا توجد مهام حالية. أضف مهمة جديدة من النموذج أعلاه.</div>';
        return;
      }
      container.innerHTML = "";

      currentTasks.forEach(t => {
        const row = document.createElement("div");
        row.className = "current-task-row";

        let statusText = "لم تبدأ";
        let statusClass = "status-new";
        if (t.status === "running") {
          statusText = "قيد التنفيذ";
          statusClass = "status-running";
        } else if (t.status === "paused") {
          statusText = "متوقفة مؤقتاً";
          statusClass = "status-paused";
        }

        row.innerHTML = `
          <div><strong>${t.taskType}</strong><br/><span style="color:#6b7280;">${t.productCode || t.assignedText || ""}</span></div>
          <div>${t.productCategory || "-"}</div>
          <div class="task-timer">${formatSeconds(t.seconds)}</div>
          <div><span class="status-pill ${statusClass}">${statusText}</span></div>
          <div>
            <button class="small" onclick="startTask(${t.id})">بدء/استئناف</button>
            <button class="small secondary" onclick="pauseTask(${t.id})">إيقاف</button>
          </div>
          <div>
            <button class="small secondary" onclick="finishTask(${t.id})">إنهاء وحفظ</button>
          </div>
        `;
        container.appendChild(row);
      });
    }

    function startTask(id) {
      const t = currentTasks.find(x => x.id === id);
      if (!t) return;
      t.running = true;
      t.status = "running";
      renderCurrentTasks();
    }

    function pauseTask(id) {
      const t = currentTasks.find(x => x.id === id);
      if (!t) return;
      t.running = false;
      if (t.seconds === 0) {
        t.status = "new";
      } else {
        t.status = "paused";
      }
      renderCurrentTasks();
    }

    async function finishTask(id) {
      const tIndex = currentTasks.findIndex(x => x.id === id);
      if (tIndex === -1) return;
      const t = currentTasks[tIndex];

      if (t.seconds === 0) {
        if (!confirm("لم يتم تشغيل العداد لهذه المهمة. حفظها بوقت 0 دقيقة؟")) {
          return;
        }
      }
      t.running = false;
      t.status = "paused";

      const minutes = Math.round(t.seconds / 60);

      const msg = document.getElementById("saveMsg");
      msg.textContent = "...جاري حفظ المهمة";

      const payload = {
        employeeCode: t.employeeCode,
        employeeName: t.employeeName,
        taskDate: t.taskDate,
        taskType: t.taskType,
        productCode: t.productCode,
        productCategory: t.productCategory,
        branchCount: t.branchCount,
        assignedText: t.assignedText,
        assignedLink: t.assignedLink,
        durationMinutes: minutes
      };

      try {
        const res = await callApi("saveTask", payload);
        if (res.success) {
          msg.textContent = "تم حفظ المهمة بنجاح. رقم المهمة: " + res.taskId;
          currentTasks.splice(tIndex, 1);
          renderCurrentTasks();
          loadEmployeeTasks();
        } else {
          msg.textContent = "فشل حفظ المهمة";
        }
      } catch (err) {
        console.error(err);
        msg.textContent = "حدث خطأ في حفظ المهمة";
      }
    }

    // تحميل جميع المهام السابقة من الشيت
    async function loadEmployeeTasks() {
      const tbody = document.querySelector("#tasksTable tbody");
      tbody.innerHTML = '<tr><td colspan="9">...جاري التحميل</td></tr>';
      try {
        const list = await callApi("getEmployeeTasks", { employeeCode: user.employeeCode });
        tbody.innerHTML = "";
        if (!list || !list.length) {
          tbody.innerHTML = '<tr><td colspan="9">لا توجد مهام مسجلة بعد</td></tr>';
          return;
        }
        list.forEach(t => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${t.TaskID || ""}</td>
            <td>${t.TaskDate ? new Date(t.TaskDate).toLocaleDateString("ar-SY") : ""}</td>
            <td>${t.TaskType || ""}</td>
            <td>${t.ProductCode || ""}</td>
            <td>${t.DurationMinutes || ""}</td>
            <td>${t.AuditStatus || ""}</td>
            <td>${t.QualityEarned || ""}/${t.QualityPossible || ""}</td>
            <td style="max-width:160px;">${t.AuditorNotes || ""}</td>
            <td>
              <span class="followup-btn" onclick="markFollowUp(${t.TaskID}, true)">تم التنفيذ</span>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="9">خطأ في تحميل المهام</td></tr>';
      }
    }

    async function markFollowUp(taskId, done) {
      await callApi("setEmployeeFollowUp", { taskId, done });
      loadEmployeeTasks();
    }

    async function searchRulesClick() {
      const q = document.getElementById("ruleQuery").value;
      const listEl = document.getElementById("rulesList");
      listEl.innerHTML = "...بحث";
      try {
        const res = await callApi("searchRules", { query: q });
        if (!res || res.length === 0) {
          listEl.innerHTML = "<div>لا توجد قواعد مطابقة</div>";
          return;
        }
        listEl.innerHTML = "";
        res.forEach(r => {
          const div = document.createElement("div");
          div.className = "rule-item";
          div.innerHTML = `
            <div class="rule-title">${r.Title || ""}</div>
            <div>${r.Details || ""}</div>
            <div style="color:#666;font-size:0.75rem;">فئات: ${r.Categories || ""}</div>
          `;
          listEl.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        listEl.innerHTML = "<div>خطأ في البحث</div>";
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
