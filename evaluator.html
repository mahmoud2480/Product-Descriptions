<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:"Cairo",system-ui,sans-serif; background:#f4f7fb; }

    header {
      background:#0d6efd; color:#fff; padding:10px 16px;
      display:flex; flex-direction:column; gap:8px;
    }
    .header-top {
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:1.1rem; }
    header a{color:#fff;}

    .nav-buttons {
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .nav-buttons button {
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.7);
      background:rgba(255,255,255,0.1);
      color:#fff;
      font-family:"Cairo",system-ui,sans-serif;
      font-size:0.8rem;
      cursor:pointer;
    }
    .nav-buttons button:hover {
      background:rgba(255,255,255,0.25);
    }
    .nav-buttons button.active {
      background:#fff;
      color:#0d6efd;
    }

    .container { padding:10px; }
    table { width:100%; border-collapse:collapse; font-size:0.8rem; margin-top:8px; }
    th, td { border:1px solid #eee; padding:4px 6px; text-align:center; }
    th { background:#f1f3f7; }
    .filters { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px; }
    select { padding:4px 6px; border-radius:8px; border:1px solid #ddd; font-family:inherit; font-size:0.85rem; }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</h1>
      <div>
        <span id="evalName"></span> |
        <a href="#" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>
  <div class="container">
    <div class="filters">
      <div>
        <label>Ø§Ù„Ø´Ù‡Ø±</label><br/>
        <select id="monthFilter" onchange="loadEvaluation()"></select>
      </div>
      <div>
        <label>ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label><br/>
        <select id="sortBy" onchange="renderTable(lastData)">
          <option value="totalScore">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</option>
          <option value="qualityScore">Ø§Ù„Ø¬ÙˆØ¯Ø©</option>
          <option value="productCountScore">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</option>
          <option value="speedScore">Ø§Ù„Ø³Ø±Ø¹Ø©</option>
        </select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
          <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
          <th>Ø§Ù„Ø¬ÙˆØ¯Ø© 35%</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª 15%</th>
          <th>ØªÙ†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª 10%</th>
          <th>ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª 5%</th>
          <th>Ø§Ù„Ø³Ø±Ø¹Ø© 15%</th>
          <th>Ø§Ù„ØªØ¹Ø§ÙˆÙ† ÙˆØ§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ 10%</th>
          <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ 10%</th>
          <th>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© 100%</th>
        </tr>
      </thead>
      <tbody id="evalBody"></tbody>
    </table>
  </div>

  <!-- Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù„ÙƒÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª -->
  <script src="config.js"></script>

  <script>
    const API_URL = window.API_URL;

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload })
      });
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error("JSON parse error:", text);
        throw e;
      }
    }

    let user = null;
    let lastData = [];

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    function hasRole(code) {
      if (!user || !user.role) return false;
      const rolesText = user.role.toString().toUpperCase();
      return rolesText.includes(code);
    }

    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

const links = [
  { code: "EMP",              label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù",   href: "employee.html" },
  { code: "EMP",              label: "Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù",   href: "ideas.html" },
  { code: "AUDITOR_EXTENDED", label: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚",    href: "auditor.html" },
  { code: "EVALUATOR",        label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",  href: "evaluator.html" },
  { code: "ADMIN",            label: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",   href: "admin.html" },
  { code: "ADMIN",            label: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±",  href: "ideas_admin.html" },

  // ğŸ”¥ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
  { code: "AUDITOR_EXTENDED", label: "ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©", href: "reports.html" }
];


      links.forEach(item => {
        if (!hasRole(item.code)) return;
        const btn = document.createElement("button");
        btn.textContent = item.label;
        if (activeHref === item.href) btn.classList.add("active");
        btn.onclick = () => {
          if (!window.location.pathname.endsWith(item.href)) {
            window.location.href = item.href;
          }
        };
        container.appendChild(btn);
      });
    }

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);

      if (!hasRole("EVALUATOR") && !hasRole("ADMIN")) {
        window.location.href = "employee.html";
        return;
      }

      document.getElementById("evalName").textContent =
        user.name + " (" + user.role + ")";
      renderNav("evaluator.html");

      const sel = document.getElementById("monthFilter");
      const now = new Date();
      sel.innerHTML = "";
      // Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø± Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ
      for (let i = 0; i < 6; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const y = d.getFullYear();
        const m = ("0" + (d.getMonth() + 1)).slice(-2);
        const key = y + "-" + m;
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        sel.appendChild(opt);
      }

      loadEvaluation();
    }

    async function loadEvaluation() {
      const monthKey = document.getElementById("monthFilter").value;
      const tbody = document.getElementById("evalBody");
      tbody.innerHTML = '<tr><td colspan="10">...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';

      try {
        const data = await callApi("getEvaluation", { monthKey });

        // Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±Ø¬Ù‘Ø¹ ÙƒØ§Ø¦Ù† Ø®Ø·Ø£
        if (!Array.isArray(data)) {
          console.warn("getEvaluation response:", data);
          tbody.innerHTML =
            '<tr><td colspan="10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª (Ø£Ùˆ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…)</td></tr>';
          lastData = [];
          return;
        }

        lastData = data;
        renderTable(lastData);
      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          '<tr><td colspan="10">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById("evalBody");
      tbody.innerHTML = "";

      if (!Array.isArray(data) || !data.length) {
        tbody.innerHTML = '<tr><td colspan="10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
        return;
      }

      const sortBy = document.getElementById("sortBy").value;
      const sorted = data.slice().sort(
        (a, b) => (b[sortBy] || 0) - (a[sortBy] || 0)
      );

      sorted.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${r.employeeName}</td>
          <td>${r.qualityScore.toFixed(2)}</td>
          <td>${r.productCountScore.toFixed(2)}</td>
          <td>${r.varietyScore.toFixed(2)}</td>
          <td>${r.diffScore.toFixed(2)}</td>
          <td>${r.speedScore.toFixed(2)}</td>
          <td>${r.ideaScore.toFixed(2)}</td>
          <td>${r.testScore.toFixed(2)}</td>
          <td><strong>${r.totalScore.toFixed(2)}</strong></td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
