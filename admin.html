<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة الإدارة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:"Cairo",system-ui,sans-serif; background:#f4f7fb; }
 
    header {
      background:#0d6efd; color:#fff; padding:10px 16px;
      display:flex; flex-direction:column; gap:8px;
    }
    .header-top {
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:1.1rem; }
    header a{color:#fff;}

    .nav-buttons {
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .nav-buttons button {
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.7);
      background:rgba(255,255,255,0.1);
      color:#fff;
      font-family:"Cairo",system-ui,sans-serif;
      font-size:0.8rem;
      cursor:pointer;
    }
    .nav-buttons button:hover {
      background:rgba(255,255,255,0.25);
    }
    .nav-buttons button.active {
      background:#fff;
      color:#0d6efd;
    }

    .container {
      padding:10px;
      display:grid;
      gap:10px;
      grid-template-columns:1.2fr 1.8fr;
    }
    @media (max-width:900px) {
      .container { grid-template-columns:1fr; }
    }
    .card {
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    h2 { margin:0 0 8px; font-size:1rem; }
    label { display:block; margin-top:6px; font-size:0.85rem; }

    input, textarea {
      width:100%; padding:7px 8px;
      border-radius:10px; border:1px solid #ddd;
      font-family:inherit; font-size:0.85rem;
      box-sizing:border-box;
    }
    textarea { min-height:60px; resize:vertical; }

    button {
      margin-top:8px; padding:7px 10px;
      border-radius:10px;
      border:none; background:#0d6efd; color:#fff;
      font-family:inherit; font-size:0.85rem;
      cursor:pointer;
    }

    table {
      width:100%; border-collapse:collapse;
      font-size:0.8rem; margin-top:6px;
    }
    th, td {
      border:1px solid #eee;
      padding:4px 6px;
    }
    th { background:#f1f3f7; }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>لوحة الإدارة</h1>
      <div>
        <span id="adminName"></span> |
        <a href="#" onclick="logout()">تسجيل الخروج</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <div class="container">
    <!-- إضافة قاعدة -->
    <div class="card">
      <h2>إضافة قاعدة جديدة</h2>

      <label>نوع القاعدة</label>
      <input id="ruleType" placeholder="مثال: رفع منتج / صور / عامة" />

      <label>الفئات (مفصولة بفاصلة)</label>
      <input id="ruleCats" placeholder="ملابس, شتوي, رجالي" />

      <label>عنوان القاعدة</label>
      <input id="ruleTitle" />

      <label>تفاصيل القاعدة</label>
      <textarea id="ruleDetails"></textarea>

      <label>أمثلة / روابط</label>
      <textarea id="ruleExamples"></textarea>

      <button onclick="saveRule()">حفظ القاعدة</button>
      <div id="ruleMsg" style="margin-top:6px;font-size:0.8rem;color:#0a7;"></div>
    </div>

    <!-- أحدث القواعد -->
    <div class="card">
      <h2>أحدث القواعد</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>نوع</th>
            <th>عنوان</th>
            <th>فئات</th>
          </tr>
        </thead>
        <tbody id="rulesBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ✅ تحميل إعدادات الـ API المشتركة -->
  <script src="config.js"></script>

  <script>
    const API_URL = window.API_URL;

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload })
      });
      const text = await res.text();
      return JSON.parse(text);
    }

    let user = null;

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    // ✅ دالة صلاحيات موحّدة
    function hasRole(code) {
      if (!user || !user.role) return false;

      const rolesTextUpper = user.role.toString().toUpperCase();
      const rolesTextRaw   = user.role.toString();

      // صلاحيات موسعة: مدقق/مدير/رئيس قسم
      if (code === "AUDITOR_EXTENDED") {
        return (
          rolesTextUpper.includes("AUDITOR") ||
          rolesTextUpper.includes("ADMIN")   ||
          rolesTextUpper.includes("MANAGER") ||
          rolesTextRaw.includes("مدير")      ||
          rolesTextRaw.includes("رئيس قسم")  ||
          rolesTextRaw.includes("مدقق")
        );
      }

      // باقي الأكواد: EMP, ADMIN, EVALUATOR ...
      return rolesTextUpper.includes(code);
    }

    // ✅ شريط التنقل الموحد
    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

      const links = [
        { code: "EMP",              label: "واجهة الموظف",   href: "employee.html" },
        { code: "EMP",              label: "أفكار الموظف",   href: "ideas.html" },
        { code: "AUDITOR_EXTENDED", label: "لوحة المدقق",    href: "auditor.html" },
        { code: "EVALUATOR",        label: "واجهة التقييم",  href: "evaluator.html" },
        { code: "ADMIN",            label: "لوحة الإدارة",   href: "admin.html" },
        { code: "ADMIN",            label: "إدارة الأفكار",  href: "ideas_admin.html" },
        { code: "EVALUATOR",        label: "الاختبار الشهري", href: "tests.html" },
        { code: "SUPPORT",          label: "الدعم الفني",     href: "support.html" },
        { code: "AUDITOR_EXTENDED", label: "تقارير ",  href: "reports.html" }
      ];

      links.forEach(item => {
        if (!hasRole(item.code)) return;
        const btn = document.createElement("button");
        btn.textContent = item.label;
        if (activeHref === item.href) btn.classList.add("active");
        btn.onclick = () => {
          if (!window.location.pathname.endsWith(item.href)) {
            window.location.href = item.href;
          }
        };
        container.appendChild(btn);
      });
    }

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);

      // السماح فقط لمن لديه دور ADMIN لهذه الصفحة
      if (!hasRole("ADMIN")) {
        window.location.href = "employee.html";
        return;
      }

      document.getElementById("adminName").textContent =
        user.name + " (" + user.role + ")";
      renderNav("admin.html");
      loadRulesList();
    }

    async function saveRule() {
      const type     = document.getElementById("ruleType").value.trim();
      const catsText = document.getElementById("ruleCats").value.trim();
      const title    = document.getElementById("ruleTitle").value.trim();
      const details  = document.getElementById("ruleDetails").value.trim();
      const examples = document.getElementById("ruleExamples").value.trim();
      const msg      = document.getElementById("ruleMsg");

      if (!title || !details) {
        msg.style.color = "#b91c1c";
        msg.textContent = "يجب إدخال العنوان والتفاصيل.";
        return;
      }

      msg.style.color = "#374151";
      msg.textContent = "...جاري الحفظ";

      const ruleObj = {
        type,
        categories: catsText ? catsText.split(",").map(s => s.trim()) : [],
        title,
        details,
        examples
      };

      try {
        const res = await callApi("addRule", { ruleObj, adminName: user.name });
        if (res.success) {
          msg.style.color = "#16a34a";
          msg.textContent = "تم حفظ القاعدة رقم " + res.ruleId;
          loadRulesList();
        } else {
          msg.style.color = "#b91c1c";
          msg.textContent = "فشل الحفظ.";
        }
      } catch (err) {
        console.error(err);
        msg.style.color = "#b91c1c";
        msg.textContent = "خطأ في الاتصال بالسيرفر.";
      }
    }

    async function loadRulesList() {
      const tbody = document.getElementById("rulesBody");
      tbody.innerHTML = '<tr><td colspan="4">...جاري التحميل</td></tr>';

      try {
        const res = await callApi("searchRules", { query: "" });
        const list = res || [];
        tbody.innerHTML = "";

        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="4">لا توجد قواعد</td></tr>';
          return;
        }

        list.slice(-20).forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.RuleID}</td>
            <td>${r.RuleType || ""}</td>
            <td>${r.Title || ""}</td>
            <td>${r.Categories || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          '<tr><td colspan="4">خطأ في تحميل القواعد</td></tr>';
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
