<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة المدقق</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Cairo", system-ui, sans-serif;
      background: #f4f7fb;
    }

    header {
      background: #0d6efd;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header a {
      color: #fff;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .nav-buttons button {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-family: "Cairo", system-ui, sans-serif;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .nav-buttons button:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .nav-buttons button.active {
      background: #fff;
      color: #0d6efd;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.5fr;
      gap: 10px;
      padding: 10px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    /* جدول المهام */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th,
    td {
      border: 1px solid #eee;
      padding: 4px 6px;
      text-align: center;
    }
    th {
      background: #f1f3f7;
    }
    tr:hover {
      background: #f9fafc;
      cursor: pointer;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 0.8rem;
      align-items: flex-end;
    }
    .filters label {
      font-size: 0.75rem;
      color: #4b5563;
    }
    .filters select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.8rem;
    }

    /* تفاصيل التدقيق */
    label {
      display: block;
      margin-top: 6px;
      font-size: 0.85rem;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.9rem;
      padding: 6px 8px;
    }
    select,
    input {
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.9rem;
      padding: 4px 6px;
      box-sizing: border-box;
    }

    button {
      margin-top: 8px;
      padding: 7px 12px;
      border-radius: 10px;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .msg {
      margin-top: 4px;
      font-size: 0.8rem;
      min-height: 1.2em;
    }

    .rule-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }
    .rule-text {
      flex: 1;
      text-align: right;
    }
    .rule-points {
      white-space: nowrap;
      font-size: 0.75rem;
      color: #6b7280;
      margin-inline: 4px;
    }
    .rule-options {
      display: flex;
      gap: 4px;
      white-space: nowrap;
    }
    .rule-options label {
      margin: 0;
      font-size: 0.75rem;
    }

    .product-frame {
      width: 100%;
      height: 200px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      margin-top: 6px;
    }

    .summary-box {
      margin-top: 6px;
      font-size: 0.8rem;
      background: #f9fafb;
      border-radius: 8px;
      padding: 6px 8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>لوحة المدقق</h1>
      <div>
        <span id="userName"></span> |
        <a href="#" onclick="logout()">تسجيل الخروج</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <div class="layout">
    <!-- تفاصيل التدقيق -->
    <div class="card">
      <h2>تفاصيل التدقيق</h2>
      <div id="detailsArea">
        اختر مهمة من الجدول لعرض التفاصيل.
      </div>
    </div>

    <!-- قائمة المهام -->
    <div class="card">
      <h2>المهام المطلوبة للتدقيق</h2>
      <div class="filters">
        <div>
          <label>الشهر</label><br />
          <select id="filterMonth" onchange="reloadTasks()"></select>
        </div>
        <div>
          <label>حالة التدقيق</label><br />
          <select id="filterStatus" onchange="applyFiltersAndRender()">
            <option value="">الكل</option>
            <option value="غير مدقق">غير مدقق</option>
            <option value="تم التدقيق">تم التدقيق</option>
            <option value="يحتاج تعديل">يحتاج تعديل</option>
          </select>
        </div>
        <div>
          <label>الموظف</label><br />
          <select id="filterEmployee" onchange="reloadTasks()">
            <option value="">الكل</option>
          </select>
        </div>
        <div>
          <label>نوع المهمة</label><br />
          <select id="filterTaskType" onchange="applyFiltersAndRender()">
            <option value="">الكل</option>
            <option value="رفع منتج">رفع منتج</option>
            <option value="مهمة موكلة">مهمة موكلة</option>
          </select>
        </div>
        <div>
          <label>تصنيف المنتج</label><br />
          <select id="filterCategory" onchange="applyFiltersAndRender()">
            <option value="">الكل</option>
          </select>
        </div>
      </div>

      <div style="max-height: calc(100vh - 210px); overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>كود الموظف</th>
              <th>اسم الموظف</th>
              <th>نوع المهمة</th>
              <th>كود المنتج</th>
              <th>تصنيف المنتج</th>
              <th>تاريخ المهمة</th>
              <th>حالة التدقيق</th>
              <th>نقاط الجودة</th>
            </tr>
          </thead>
          <tbody id="tasksBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ✅ تحميل إعدادات الـ API المشتركة -->
  <script src="config.js"></script>

  <script>
    // استخدام الرابط القادم من config.js
    const API_URL = window.API_URL;

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload }),
      });
      const txt = await res.text();
      return JSON.parse(txt);
    }

    let user = null;
    let allTasks = [];
    let currentTaskId = null;

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    function hasRole(code) {
      if (!user || !user.role) return false;
      const rolesText = user.role.toString().toUpperCase();
      return rolesText.includes(code);
    }

    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

      const links = [
        { code: "EMP", label: "واجهة الموظف", href: "employee.html" },
        { code: "EMP", label: "أفكار الموظف", href: "ideas.html" },
        { code: "AUDITOR", label: "لوحة المدقق", href: "auditor.html" },
        { code: "EVALUATOR", label: "واجهة التقييم", href: "evaluator.html" },
        { code: "ADMIN", label: "لوحة الإدارة", href: "admin.html" },
        { code: "ADMIN", label: "إدارة الأفكار", href: "ideas_admin.html" },
      ];

      links.forEach((item) => {
        if (!hasRole(item.code)) return;
        const btn = document.createElement("button");
        btn.textContent = item.label;
        if (activeHref === item.href) btn.classList.add("active");
        btn.onclick = () => {
          if (!window.location.pathname.endsWith(item.href)) {
            window.location.href = item.href;
          }
        };
        container.appendChild(btn);
      });
    }

    function initMonthFilter() {
      const sel = document.getElementById("filterMonth");
      const now = new Date();

      sel.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "كل الأشهر";
      sel.appendChild(allOpt);

      for (let i = 0; i < 6; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const y = d.getFullYear();
        const m = ("0" + (d.getMonth() + 1)).slice(-2);
        const key = y + "-" + m;
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        sel.appendChild(opt);
      }

      const currentKey =
        now.getFullYear() + "-" + ("0" + (now.getMonth() + 1)).slice(-2);
      sel.value = currentKey;
    }

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);

      // فقط AUDITOR أو ADMIN
      if (!hasRole("AUDITOR") && !hasRole("ADMIN")) {
        window.location.href = "employee.html";
        return;
      }

      document.getElementById("userName").textContent =
        user.name + " (" + user.employeeCode + ")";
      renderNav("auditor.html");
      initMonthFilter();
      reloadTasks();
    }

    async function reloadTasks() {
      const tbody = document.getElementById("tasksBody");
      tbody.innerHTML = "<tr><td colspan='9'>...جاري التحميل</td></tr>";

      const monthKey = document.getElementById("filterMonth").value || null;
      const empCode = document.getElementById("filterEmployee").value || null;

      try {
        const res = await callApi("getTasksForAudit", {
          filters: { monthKey: monthKey, employeeCode: empCode },
        });

        allTasks = res || [];
        buildEmployeeFilterFromData();
        buildCategoryFilterFromData();
        applyFiltersAndRender();
      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          "<tr><td colspan='9'>خطأ في الاتصال بالسيرفر</td></tr>";
      }
    }

    function buildEmployeeFilterFromData() {
      const sel = document.getElementById("filterEmployee");
      const oldVal = sel.value;
      const set = new Set();
      allTasks.forEach((t) => {
        if (t.EmployeeCode) {
          set.add(t.EmployeeName + "|" + t.EmployeeCode);
        }
      });

      sel.innerHTML = '<option value="">الكل</option>';
      set.forEach((v) => {
        const [name, code] = v.split("|");
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = name + " (" + code + ")";
        sel.appendChild(opt);
      });

      if ([...set].some((v) => v.split("|")[1] === oldVal)) {
        sel.value = oldVal;
      }
    }

    function buildCategoryFilterFromData() {
      const sel = document.getElementById("filterCategory");
      const oldVal = sel.value;
      const set = new Set();
      allTasks.forEach((t) => {
        if (t.ProductCategory) set.add(t.ProductCategory);
      });

      sel.innerHTML = '<option value="">الكل</option>';
      set.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        sel.appendChild(opt);
      });

      if (set.has(oldVal)) {
        sel.value = oldVal;
      }
    }

    function applyFiltersAndRender() {
      const tbody = document.getElementById("tasksBody");
      if (!allTasks.length) {
        tbody.innerHTML =
          "<tr><td colspan='9'>لا توجد مهام مطابقة للفلاتر الحالية</td></tr>";
        document.getElementById("detailsArea").textContent =
          "اختر مهمة من الجدول لعرض التفاصيل.";
        return;
      }

      const status = document.getElementById("filterStatus").value || "";
      const type = document.getElementById("filterTaskType").value || "";
      const cat = document.getElementById("filterCategory").value || "";

      const filtered = allTasks.filter((t) => {
        if (status && String(t.AuditStatus || "") !== status) return false;
        if (type && String(t.TaskType || "") !== type) return false;
        if (cat && String(t.ProductCategory || "") !== cat) return false;
        return true;
      });

      if (!filtered.length) {
        tbody.innerHTML =
          "<tr><td colspan='9'>لا توجد مهام مطابقة للفلاتر الحالية</td></tr>";
        document.getElementById("detailsArea").textContent =
          "اختر مهمة من الجدول لعرض التفاصيل.";
        return;
      }

      tbody.innerHTML = "";
      filtered.forEach((t) => {
        const tr = document.createElement("tr");
        const d = t.TaskDate
          ? new Date(t.TaskDate).toLocaleDateString("ar-SY")
          : "";
        const qualityText =
          (t.QualityEarned || 0) +
          " / " +
          (t.QualityPossible || 0) +
          (t.QualityPossible
            ? " (" + (t.QualityPercent || 0).toFixed?.(0) + "%)"
            : "");

        tr.innerHTML = `
          <td>${t.TaskID}</td>
          <td>${t.EmployeeCode || ""}</td>
          <td>${t.EmployeeName || ""}</td>
          <td>${t.TaskType || ""}</td>
          <td>${t.ProductCode || ""}</td>
          <td>${t.ProductCategory || ""}</td>
          <td>${d}</td>
          <td>${t.AuditStatus || ""}</td>
          <td>${qualityText}</td>
        `;
        tr.onclick = () => openTaskDetails(t.TaskID);
        tbody.appendChild(tr);
      });
    }

    async function openTaskDetails(taskId) {
      currentTaskId = taskId;
      const container = document.getElementById("detailsArea");
      container.innerHTML = "...جاري تحميل تفاصيل المهمة";

      try {
        const res = await callApi("getAuditDetails", { taskId: taskId });
        if (!res.success) {
          container.textContent = "تعذر جلب تفاصيل المهمة.";
          return;
        }

        const task = res.task || {};
        const product = res.product || null;
        const rules = res.qualityRules || [];

        const d = task.TaskDate
          ? new Date(task.TaskDate).toLocaleString("ar-SY")
          : "";

        let productHtml = `<div>لا توجد بيانات منتج لهذه المهمة.</div>`;
        if (product) {
          productHtml = `
            <div><strong>اسم المنتج:</strong> ${product.ProductName || ""}</div>
            <div><strong>كود المنتج:</strong> ${product.ProductCode || ""}</div>
            ${
              product.ProductURL
                ? `<div><a href="${product.ProductURL}" target="_blank">فتح المنتج في صفحة جديدة</a></div>
                   <iframe class="product-frame" src="${product.ProductURL}"></iframe>`
                : ""
            }
          `;
        }

        let rulesHtml = "";
        if (!rules.length) {
          rulesHtml = "<div>لا توجد قواعد جودة لهذا المنتج / هذه المهمة.</div>";
        } else {
          rulesHtml = rules
            .map((r, index) => {
              const id = "rule_" + index;
              return `
              <div class="rule-row" data-rule-index="${index}">
                <div class="rule-text">${r.Description || ""}</div>
                <div class="rule-points">${r.Points || 0} نقطة</div>
                <div class="rule-options">
                  <label><input type="radio" name="${id}" value="correct" /> ✅ صح</label>
                  <label><input type="radio" name="${id}" value="wrong" /> ❌ خطأ</label>
                  <label><input type="radio" name="${id}" value="na" checked /> ⭕ لا ينطبق</label>
                </div>
              </div>
            `;
            })
            .join("");
        }

        const follow =
          task.EmployeeFollowUp === "YES"
            ? "نعم"
            : task.EmployeeFollowUp === "NO"
            ? "لا"
            : "غير محدد";

        container.innerHTML = `
          <div><strong>الموظف:</strong> ${task.EmployeeName || ""} (${task.EmployeeCode || ""})</div>
          <div><strong>تاريخ المهمة:</strong> ${d}</div>
          <div><strong>نوع المهمة:</strong> ${task.TaskType || ""}</div>
          <div><strong>كود المنتج:</strong> ${task.ProductCode || ""}</div>
          <div><strong>تصنيف المنتج:</strong> ${task.ProductCategory || ""}</div>
          <div><strong>تنفيذ ملاحظات التدقيق:</strong> ${follow}</div>
          <hr />

          <h3 style="font-size:0.95rem;">بيانات المنتج</h3>
          ${productHtml}
          <hr />

          <h3 style="font-size:0.95rem;">بنود الجودة</h3>
          <div id="rulesContainer">
            ${rulesHtml}
          </div>

          <div class="summary-box" id="qualitySummary">
            مجموع النقاط: 0 / 0 (0%)
          </div>

          <label>ملاحظات المدقق للموظف</label>
          <textarea id="auditNotes">${task.AuditorNotes || ""}</textarea>

          <label>حالة التدقيق</label>
          <select id="auditStatus">
            <option value="غير مدقق"${
              task.AuditStatus === "غير مدقق" ? " selected" : ""
            }>غير مدقق</option>
            <option value="تم التدقيق"${
              task.AuditStatus === "تم التدقيق" ? " selected" : ""
            }>تم التدقيق</option>
            <option value="يحتاج تعديل"${
              task.AuditStatus === "يحتاج تعديل" ? " selected" : ""
            }>يحتاج تعديل</option>
          </select>

          <button onclick="saveAudit()">حفظ التدقيق</button>
          <div class="msg" id="auditMsg"></div>
        `;

        const rulesContainer = document.getElementById("rulesContainer");
        if (rulesContainer && rules.length) {
          rulesContainer.addEventListener("change", updateQualitySummary);
          updateQualitySummary();
        }
      } catch (err) {
        console.error(err);
        container.textContent = "حدث خطأ أثناء تحميل التفاصيل.";
      }
    }

    function updateQualitySummary() {
      const summaryEl = document.getElementById("qualitySummary");
      if (!summaryEl) return;

      const rulesContainer = document.getElementById("rulesContainer");
      const rows = rulesContainer
        ? rulesContainer.querySelectorAll(".rule-row")
        : [];
      let totalPossible = 0;
      let totalEarned = 0;

      rows.forEach((row) => {
        const ptsText = row.querySelector(".rule-points").textContent || "0";
        const pts = Number(ptsText.replace(/[^\d.]/g, "")) || 0;
        if (pts <= 0) return;
        totalPossible += pts;

        const input = row.querySelector('input[type="radio"]:checked');
        if (input && input.value === "correct") {
          totalEarned += pts;
        }
      });

      const percent = totalPossible > 0 ? (totalEarned / totalPossible) * 100 : 0;
      summaryEl.textContent =
        "مجموع النقاط: " +
        totalEarned +
        " / " +
        totalPossible +
        " (" +
        percent.toFixed(0) +
        "%)";
    }

    async function saveAudit() {
      if (currentTaskId == null) return;
      const msg = document.getElementById("auditMsg");
      msg.style.color = "#374151";
      msg.textContent = "...جاري الحفظ";

      const rulesContainer = document.getElementById("rulesContainer");
      const rows = rulesContainer
        ? rulesContainer.querySelectorAll(".rule-row")
        : [];
      const ruleResults = [];

      rows.forEach((row) => {
        const index = row.getAttribute("data-rule-index");
        const descEl = row.querySelector(".rule-text");
        const ptsText = row.querySelector(".rule-points").textContent || "0";
        const pts = Number(ptsText.replace(/[^\d.]/g, "")) || 0;
        const input = row.querySelector('input[type="radio"]:checked');
        const status = input ? input.value : "na";
        ruleResults.push({
          ruleId: index,
          description: descEl ? descEl.textContent : "",
          status: status,
          points: pts,
        });
      });

      const notes = document.getElementById("auditNotes").value || "";
      const status = document.getElementById("auditStatus").value || "تم التدقيق";

      try {
        const res = await callApi("saveAudit", {
          taskId: currentTaskId,
          ruleResults: ruleResults,
          notes: notes,
          status: status,
        });

        if (res.success) {
          msg.style.color = "#16a34a";
          msg.textContent = "تم حفظ التدقيق بنجاح.";
          reloadTasks();
        } else {
          msg.style.color = "#b91c1c";
          msg.textContent = "فشل الحفظ.";
        }
      } catch (err) {
        console.error(err);
        msg.style.color = "#b91c1c";
        msg.textContent = "خطأ في الاتصال بالسيرفر.";
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
