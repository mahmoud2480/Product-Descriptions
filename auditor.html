<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Cairo", system-ui, sans-serif;
      background: #f4f7fb;
    }

    header {
      background: #0d6efd;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header a {
      color: #fff;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .nav-buttons button {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-family: "Cairo", system-ui, sans-serif;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .nav-buttons button:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .nav-buttons button.active {
      background: #fff;
      color: #0d6efd;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.5fr;
      gap: 10px;
      padding: 10px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th,
    td {
      border: 1px solid #eee;
      padding: 4px 6px;
      text-align: center;
    }
    th {
      background: #f1f3f7;
    }
    tr:hover {
      background: #f9fafc;
      cursor: pointer;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 0.8rem;
      align-items: flex-end;
    }
    .filters label {
      font-size: 0.75rem;
      color: #4b5563;
    }
    .filters select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.8rem;
    }

    label {
      display: block;
      margin-top: 6px;
      font-size: 0.85rem;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.9rem;
      padding: 6px 8px;
    }
    select,
    input {
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.9rem;
      padding: 4px 6px;
      box-sizing: border-box;
    }

    button {
      margin-top: 8px;
      padding: 7px 12px;
      border-radius: 10px;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .msg {
      margin-top: 4px;
      font-size: 0.8rem;
      min-height: 1.2em;
    }

    /* â­ ØªÙ†Ø³ÙŠÙ‚ Ø£ÙˆØ¶Ø­ Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬ÙˆØ¯Ø© */
    .rule-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.95rem;          /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· */
      padding: 6px 8px;            /* Ù…Ø³Ø§ÙØ© Ø¯Ø§Ø®Ù„ÙŠØ© */
      background: #f9fafb;         /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ø®ÙÙŠÙØ© */
      border-radius: 8px;
    }

    .rule-text {
      flex: 1;
      text-align: right;
      font-weight: 700;            /* Ø¨ÙˆÙ„Ø¯ ÙˆØ§Ø¶Ø­ */
      color: #111827;              /* Ù„ÙˆÙ† Ø¯Ø§ÙƒÙ† ÙˆÙˆØ§Ø¶Ø­ */
      line-height: 1.6;
    }

    .rule-points {
      white-space: nowrap;
      font-size: 0.85rem;          /* Ø£ÙƒØ¨Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
      color: #374151;
      margin-inline: 6px;
      font-weight: 600;            /* Ø¨ÙˆÙ„Ø¯ Ø®ÙÙŠÙ */
    }

    .rule-options {
      display: flex;
      gap: 6px;
      white-space: nowrap;
    }

    .rule-options label {
      margin: 0;
      font-size: 0.8rem;           /* ØªÙƒØ¨ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø®ÙŠØ§Ø±Ø§Øª ØµØ­ / Ø®Ø·Ø£ / Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚ */
    }

    .product-frame {
      width: 100%;
      height: 200px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      margin-top: 6px;
    }

    .summary-box {
      margin-top: 6px;
      font-size: 0.8rem;
      background: #f9fafb;
      border-radius: 8px;
      padding: 6px 8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚</h1>
      <div>
        <span id="userName"></span> |
        <a href="#" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <div class="layout">
    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ -->
    <div class="card">
      <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</h2>
      <div id="detailsArea">
        Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.
      </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… -->
    <div class="card">
      <h2>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ¯Ù‚ÙŠÙ‚</h2>
      <div class="filters">
        <div>
          <label>Ø§Ù„Ø´Ù‡Ø±</label><br />
          <select id="filterMonth" onchange="applyFiltersAndRender()"></select>
        </div>
        <div>
          <label>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</label><br />
          <select id="filterStatus" onchange="applyFiltersAndRender()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="ØºÙŠØ± Ù…Ø¯Ù‚Ù‚">ØºÙŠØ± Ù…Ø¯Ù‚Ù‚</option>
            <option value="ØªÙ… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚">ØªÙ… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</option>
            <option value="ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„">ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ù…ÙˆØ¸Ù</label><br />
          <select id="filterEmployee" onchange="applyFiltersAndRender()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</label><br />
          <select id="filterTaskType" onchange="applyFiltersAndRender()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="Ø±ÙØ¹ Ù…Ù†ØªØ¬">Ø±ÙØ¹ Ù…Ù†ØªØ¬</option>
            <option value="Ù…Ù‡Ù…Ø© Ù…ÙˆÙƒÙ„Ø©">Ù…Ù‡Ù…Ø© Ù…ÙˆÙƒÙ„Ø©</option>
          </select>
        </div>
        <div>
          <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬</label><br />
          <select id="filterCategory" onchange="applyFiltersAndRender()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
      </div>

      <div style="max-height: calc(100vh - 210px); overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‡Ù…Ø©</th>
              <th>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th>
              <th>Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©</th>
            </tr>
          </thead>
          <tbody id="tasksBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ API -->
  <script src="config.js"></script>

  <script>
    const API_URL = window.API_URL;

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload }),
      });
      const txt = await res.text();
      return JSON.parse(txt);
    }

    let user = null;
    let allTasks = [];
    let currentTaskId = null;

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    // âœ… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯
    function hasRole(code) {
      if (!user || !user.role) return false;

      const rolesTextUpper = user.role.toString().toUpperCase();
      const rolesTextRaw   = user.role.toString();

      if (code === "AUDITOR_EXTENDED") {
        return (
          rolesTextUpper.includes("AUDITOR") ||
          rolesTextUpper.includes("ADMIN")   ||
          rolesTextUpper.includes("MANAGER") ||
          rolesTextRaw.includes("Ù…Ø¯ÙŠØ±")      ||
          rolesTextRaw.includes("Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù…")  ||
          rolesTextRaw.includes("Ù…Ø¯Ù‚Ù‚")
        );
      }

      return rolesTextUpper.includes(code);
    }

    // âœ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ù…Ø¹ Ø²Ø± ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©
    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

      const links = [
        { code: "EMP",              label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù",   href: "employee.html" },
        { code: "EMP",              label: "Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù",   href: "ideas.html" },
        { code: "AUDITOR_EXTENDED", label: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚",    href: "auditor.html" },
        { code: "EVALUATOR",        label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",  href: "evaluator.html" },
        { code: "ADMIN",            label: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",   href: "admin.html" },
        { code: "ADMIN",            label: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±",  href: "ideas_admin.html" },
        { code: "AUDITOR_EXTENDED", label: "ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©",  href: "reports.html" }
      ];

      links.forEach((item) => {
        if (!hasRole(item.code)) return;
        const btn = document.createElement("button");
        btn.textContent = item.label;
        if (activeHref === item.href) btn.classList.add("active");
        btn.onclick = () => {
          if (!window.location.pathname.endsWith(item.href)) {
            window.location.href = item.href;
          }
        };
        container.appendChild(btn);
      });
    }

    function initMonthFilter() {
      const sel = document.getElementById("filterMonth");
      const now = new Date();

      sel.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±";
      sel.appendChild(allOpt);

      // Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø± (Ø¨Ù…Ø§ ÙÙŠÙ‡Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)
      for (let i = 0; i < 6; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const y = d.getFullYear();
        const m = ("0" + (d.getMonth() + 1)).slice(-2);
        const key = y + "-" + m;
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        sel.appendChild(opt);
      }

      const currentKey =
        now.getFullYear() + "-" + ("0" + (now.getMonth() + 1)).slice(-2);
      sel.value = currentKey;
    }

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);

      // âœ… ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯Ù‚Ù‚ Ø§Ù„Ù…ÙˆØ³Ù‘Ø¹ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ù†Ø§
      if (!hasRole("AUDITOR_EXTENDED")) {
        window.location.href = "employee.html";
        return;
      }

      document.getElementById("userName").textContent =
        user.name + " (" + (user.employeeCode || user.role) + ")";
      renderNav("auditor.html");
      initMonthFilter();
      reloadTasks();
    }

    // ğŸ”¹ Ù†Ø·Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function reloadTasks() {
      const tbody = document.getElementById("tasksBody");
      tbody.innerHTML = "<tr><td colspan='9'>...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>";

      try {
        const res = await callApi("getTasksForAudit", {
          filters: {}
        });

        allTasks = res || [];
        buildEmployeeFilterFromData();
        buildCategoryFilterFromData();
        applyFiltersAndRender();
      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          "<tr><td colspan='9'>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±</td></tr>";
      }
    }

    function buildEmployeeFilterFromData() {
      const sel = document.getElementById("filterEmployee");
      const oldVal = sel.value;
      const set = new Set();
      allTasks.forEach((t) => {
        if (t.EmployeeCode) {
          set.add(t.EmployeeName + "|" + t.EmployeeCode);
        }
      });

      sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
      set.forEach((v) => {
        const [name, code] = v.split("|");
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = name + " (" + code + ")";
        sel.appendChild(opt);
      });

      if ([...set].some((v) => v.split("|")[1] === oldVal)) {
        sel.value = oldVal;
      }
    }

    function buildCategoryFilterFromData() {
      const sel = document.getElementById("filterCategory");
      const oldVal = sel.value;
      const set = new Set();
      allTasks.forEach((t) => {
        if (t.ProductCategory) set.add(t.ProductCategory);
      });

      sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
      set.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        sel.appendChild(opt);
      });

      if (set.has(oldVal)) {
        sel.value = oldVal;
      }
    }

    function applyFiltersAndRender() {
      const tbody = document.getElementById("tasksBody");
      if (!allTasks.length) {
        tbody.innerHTML =
          "<tr><td colspan='9'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</td></tr>";
        document.getElementById("detailsArea").textContent =
          "Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.";
        return;
      }

      const monthKey = document.getElementById("filterMonth").value || "";
      const status   = document.getElementById("filterStatus").value || "";
      const type     = document.getElementById("filterTaskType").value || "";
      const cat      = document.getElementById("filterCategory").value || "";
      const empCode  = document.getElementById("filterEmployee").value || "";

      const filtered = allTasks.filter((t) => {
        if (monthKey) {
          if (!t.TaskDate) return false;
          const dt = new Date(t.TaskDate);
          if (isNaN(dt.getTime())) return false;
          const key =
            dt.getFullYear() + "-" + ("0" + (dt.getMonth() + 1)).slice(-2);
          if (key !== monthKey) return false;
        }

        if (empCode && String(t.EmployeeCode || "") !== empCode) return false;
        if (status && String(t.AuditStatus || "") !== status) return false;
        if (type && String(t.TaskType || "") !== type) return false;
        if (cat && String(t.ProductCategory || "") !== cat) return false;

        return true;
      });

      if (!filtered.length) {
        tbody.innerHTML =
          "<tr><td colspan='9'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</td></tr>";
        document.getElementById("detailsArea").textContent =
          "Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.";
        return;
      }

      tbody.innerHTML = "";
      filtered.forEach((t) => {
        const tr = document.createElement("tr");
        const d = t.TaskDate
          ? new Date(t.TaskDate).toLocaleDateString("ar-SY")
          : "";
        const qualityEarned  = Number(t.QualityEarned || 0);
        const qualityPossible= Number(t.QualityPossible || 0);
        const percent = qualityPossible > 0
          ? Math.round((qualityEarned / qualityPossible) * 100)
          : 0;
        const qualityText =
          qualityEarned + " / " + qualityPossible +
          (qualityPossible ? " (" + percent + "%)" : "");

        tr.innerHTML = `
          <td>${t.TaskID}</td>
          <td>${t.EmployeeCode || ""}</td>
          <td>${t.EmployeeName || ""}</td>
          <td>${t.TaskType || ""}</td>
          <td>${t.ProductCode || ""}</td>
          <td>${t.ProductCategory || ""}</td>
          <td>${d}</td>
          <td>${t.AuditStatus || ""}</td>
          <td>${qualityText}</td>
        `;
        tr.onclick = () => openTaskDetails(t.TaskID);
        tbody.appendChild(tr);
      });
    }

    async function openTaskDetails(taskId) {
      currentTaskId = taskId;
      const container = document.getElementById("detailsArea");
      container.innerHTML = "...Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©";

      try {
        const res = await callApi("getAuditDetails", { taskId: taskId });
        if (!res.success) {
          container.textContent = "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©.";
          return;
        }

        const task = res.task || {};
        const product = res.product || null;
        const rules = res.qualityRules || [];

        const d = task.TaskDate
          ? new Date(task.TaskDate).toLocaleString("ar-SY")
          : "";

        // âœ… Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù + Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø¯Ù‚Ù‚
        const employeeNotes =
          task.EmployeeNotes && String(task.EmployeeNotes).trim()
            ? String(task.EmployeeNotes)
            : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù.";

        const prevNotes =
          task.AuditorNotes && String(task.AuditorNotes).trim()
            ? String(task.AuditorNotes)
            : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©.";

        let productHtml;
        if (product) {
          productHtml = `
            <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${product.ProductName || ""}</div>
            <div><strong>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${product.ProductCode || ""}</div>
            ${
              product.ProductURL
                ? `<div><a href="${product.ProductURL}" target="_blank">ÙØªØ­ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©</a></div>
                   <iframe class="product-frame" src="${product.ProductURL}"></iframe>`
                : ""
            }
            <div style="margin-top:6px;"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${employeeNotes}</div>
            <div style="margin-top:4px;"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø¯Ù‚Ù‚:</strong> ${prevNotes}</div>
          `;
        } else {
          productHtml = `
            <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ØªØ¬ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©.</div>
            <div style="margin-top:6px;"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${employeeNotes}</div>
            <div style="margin-top:4px;"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø¯Ù‚Ù‚:</strong> ${prevNotes}</div>
          `;
        }

        let rulesHtml = "";
        if (!rules.length) {
          rulesHtml = "<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø¬ÙˆØ¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ / Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©.</div>";
        } else {
          rulesHtml = rules
            .map((r, index) => {
              const id = "rule_" + index;
              const status = r.Status || "na";
              const ruleId =
                r.RuleID != null && r.RuleID !== "" ? r.RuleID : index;

              return `
              <div class="rule-row" data-rule-index="${index}" data-rule-id="${ruleId}">
                <div class="rule-text">${r.Description || ""}</div>
                <div class="rule-points">${r.Points || 0} Ù†Ù‚Ø·Ø©</div>
                <div class="rule-options">
                  <label>
                    <input type="radio" name="${id}" value="correct" ${
                status === "correct" ? "checked" : ""
              } /> âœ… ØµØ­
                  </label>
                  <label>
                    <input type="radio" name="${id}" value="wrong" ${
                status === "wrong" ? "checked" : ""
              } /> âŒ Ø®Ø·Ø£
                  </label>
                  <label>
                    <input type="radio" name="${id}" value="na" ${
                status === "na" ? "checked" : ""
              } /> â­• Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚
                  </label>
                </div>
              </div>
            `;
            })
            .join("");
        }

        const follow =
          task.EmployeeFollowUp === "YES"
            ? "Ù†Ø¹Ù…"
            : task.EmployeeFollowUp === "NO"
            ? "Ù„Ø§"
            : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

        container.innerHTML = `
          <div><strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${task.EmployeeName || ""} (${task.EmployeeCode || ""})</div>
          <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‡Ù…Ø©:</strong> ${d}</div>
          <div><strong>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©:</strong> ${task.TaskType || ""}</div>
          <div><strong>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${task.ProductCode || ""}</div>
          <div><strong>ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${task.ProductCategory || ""}</div>
          <div><strong>ØªÙ†ÙÙŠØ° Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚:</strong> ${follow}</div>
          <hr />

          <h3 style="font-size:0.95rem;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
          ${productHtml}
          <hr />

          <h3 style="font-size:0.95rem;">Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬ÙˆØ¯Ø©</h3>
          <div id="rulesContainer">
            ${rulesHtml}
          </div>

          <div class="summary-box" id="qualitySummary">
            Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·: 0 / 0 (0%)
          </div>

          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯Ù‚Ù‚ Ù„Ù„Ù…ÙˆØ¸Ù</label>
          <textarea id="auditNotes">${task.AuditorNotes || ""}</textarea>

          <label>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</label>
          <select id="auditStatus">
            <option value="ØºÙŠØ± Ù…Ø¯Ù‚Ù‚"${task.AuditStatus === "ØºÙŠØ± Ù…Ø¯Ù‚Ù‚" ? " selected" : ""}>ØºÙŠØ± Ù…Ø¯Ù‚Ù‚</option>
            <option value="ØªÙ… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚"${task.AuditStatus === "ØªÙ… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚" ? " selected" : ""}>ØªÙ… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</option>
            <option value="ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„"${task.AuditStatus === "ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„" ? " selected" : ""}>ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„</option>
          </select>

          <button onclick="saveAudit()">Ø­ÙØ¸ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</button>
          <div class="msg" id="auditMsg"></div>
        `;

        const rulesContainer = document.getElementById("rulesContainer");
        if (rulesContainer && rules.length) {
          rulesContainer.addEventListener("change", updateQualitySummary);
          updateQualitySummary();
        }
      } catch (err) {
        console.error(err);
        container.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„.";
      }
    }

    // âœ… Ù…Ù„Ø®Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¢Ù† ÙŠØ³ØªØ«Ù†ÙŠ "Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚" Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø«Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±
    function updateQualitySummary() {
      const summaryEl = document.getElementById("qualitySummary");
      if (!summaryEl) return;

      const rulesContainer = document.getElementById("rulesContainer");
      const rows = rulesContainer
        ? rulesContainer.querySelectorAll(".rule-row")
        : [];
      let totalPossible = 0;
      let totalEarned = 0;

      rows.forEach((row) => {
        const ptsText = row.querySelector(".rule-points").textContent || "0";
        const pts = Number(ptsText.replace(/[^\d.]/g, "")) || 0;
        if (pts <= 0) return;

        const input = row.querySelector('input[type="radio"]:checked');
        const status = input ? input.value : "na";

        // ÙÙ‚Ø· correct / wrong ØªØ¯Ø®Ù„ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù…ÙƒÙ†
        if (status === "correct" || status === "wrong") {
          totalPossible += pts;
          if (status === "correct") {
            totalEarned += pts;
          }
        }
        // â­• Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚ â†’ Ù„Ø§ ÙŠØ¶Ø§Ù Ù„Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù…ÙƒÙ† ÙˆÙ„Ø§ Ø§Ù„Ù…Ø­ØµÙ„
      });

      const percent = totalPossible > 0 ? (totalEarned / totalPossible) * 100 : 0;
      summaryEl.textContent =
        "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·: " +
        totalEarned +
        " / " +
        totalPossible +
        " (" +
        percent.toFixed(0) +
        "%)";
    }

    async function saveAudit() {
      if (currentTaskId == null) return;
      const msg = document.getElementById("auditMsg");
      msg.style.color = "#374151";
      msg.textContent = "...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸";

      const rulesContainer = document.getElementById("rulesContainer");
      const rows = rulesContainer
        ? rulesContainer.querySelectorAll(".rule-row")
        : [];
      const ruleResults = [];

      rows.forEach((row) => {
        const index = row.getAttribute("data-rule-index");
        const ruleId = row.getAttribute("data-rule-id");
        const descEl = row.querySelector(".rule-text");
        const ptsText = row.querySelector(".rule-points").textContent || "0";
        const pts = Number(ptsText.replace(/[^\d.]/g, "")) || 0;
        const input = row.querySelector('input[type="radio"]:checked');
        const status = input ? input.value : "na";

        ruleResults.push({
          ruleId: ruleId != null ? ruleId : index,
          description: descEl ? descEl.textContent : "",
          status: status,
          points: pts,
        });
      });

      const notes = document.getElementById("auditNotes").value || "";
      const status = document.getElementById("auditStatus").value || "ØªÙ… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚";

      try {
        const res = await callApi("saveAudit", {
          taskId: currentTaskId,
          ruleResults: ruleResults,
          notes: notes,
          status: status,
        });

        if (res.success) {
          msg.style.color = "#16a34a";
          msg.textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­.";
          reloadTasks();
        } else {
          msg.style.color = "#b91c1c";
          msg.textContent = "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.";
        }
      } catch (err) {
        console.error(err);
        msg.style.color = "#b91c1c";
        msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.";
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
