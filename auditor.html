<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة المدقق</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:"Cairo",system-ui,sans-serif; background:#f4f7fb; }

    header {
      background:#0d6efd; color:#fff; padding:10px 16px;
      display:flex; flex-direction:column; gap:8px;
    }
    .header-top {
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:1.1rem; }
    header a{color:#fff;}

    .nav-buttons {
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .nav-buttons button {
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.7);
      background:rgba(255,255,255,0.1);
      color:#fff;
      font-family:"Cairo",system-ui,sans-serif;
      font-size:0.8rem;
      cursor:pointer;
    }
    .nav-buttons button:hover {
      background:rgba(255,255,255,0.25);
    }
    .nav-buttons button.active {
      background:#fff;
      color:#0d6efd;
    }

    .layout {
      display:grid; grid-template-columns: 1.7fr 1.3fr; gap:10px; padding:10px;
    }
    @media (max-width:900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background:#fff; border-radius:14px; padding:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    h2 { margin:0 0 8px; font-size:1rem; }

    table { width:100%; border-collapse:collapse; font-size:0.8rem; }
    th, td {
      border:1px solid #eee; padding:4px 6px; text-align:center;
    }
    th { background:#f1f3f7; }
    tr:hover { background:#f9fafc; cursor:pointer; }

    .filters {
      display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px;
      font-size:0.8rem;
    }
    .filters label { font-size:0.75rem; color:#4b5563; }
    .filters select {
      padding:4px 6px;
      border-radius:8px;
      border:1px solid #ddd;
      font-family:inherit;
      font-size:0.8rem;
    }

    .side {
      max-height:calc(100vh - 100px);
      overflow-y:auto;
    }
    label { display:block; margin-top:6px; font-size:0.85rem; }
    textarea {
      width:100%; min-height:70px; border-radius:10px;
      border:1px solid #ddd; font-family:inherit; font-size:0.85rem;
    }
    select.rule-select {
      border-radius:8px; border:1px solid #ddd; padding:3px 4px; font-family:inherit; font-size:0.8rem;
    }
    button {
      margin-top:8px; padding:7px 10px; border-radius:10px;
      border:none; background:#0d6efd; color:#fff;
      font-family:inherit; font-size:0.85rem; cursor:pointer;
    }

    .rule-line {
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid #f1f1f1; padding:3px 0; font-size:0.8rem;
      gap:6px;
    }
    .rule-line:last-child { border-bottom:none; }
    .rule-desc { flex:1; }
    .rule-pts { white-space:nowrap; margin-inline:4px; }

    iframe {
      border:none; width:100%; height:180px; border-radius:10px; margin-top:4px;
    }

    .badge {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:0.72rem;
      background:#e5e7eb;
      color:#374151;
    }
    .badge-status-open { background:#fee2e2; color:#b91c1c; }
    .badge-status-done { background:#dcfce7; color:#166534; }
    .badge-status-pending { background:#fef9c3; color:#854d0e; }

    .quality-summary {
      margin-top:6px;
      font-size:0.8rem;
      padding:6px 8px;
      border-radius:10px;
      background:#f3f4f6;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>لوحة المدقق</h1>
      <div>
        <span id="audName"></span> |
        <a href="#" onclick="logout()">تسجيل الخروج</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <div class="layout">
    <!-- جدول المهام -->
    <div class="card">
      <h2>المهام المطلوبة للتدقيق</h2>
      <div class="filters">
        <div>
          <label>الشهر</label><br/>
          <select id="filterMonth" onchange="renderTasks()"></select>
        </div>
        <div>
          <label>حالة التدقيق</label><br/>
          <select id="filterStatus" onchange="renderTasks()">
            <option value="OPEN">غير مدقق / يحتاج تعديل</option>
            <option value="ALL">الكل</option>
            <option value="تم التدقيق">تم التدقيق</option>
            <option value="غير مدقق">غير مدقق فقط</option>
            <option value="يحتاج تعديل">يحتاج تعديل فقط</option>
            <option value="مرفوض">مرفوض فقط</option>
          </select>
        </div>
        <div>
          <label>الموظف</label><br/>
          <select id="filterEmployee" onchange="renderTasks()">
            <option value="">الكل</option>
          </select>
        </div>
        <div>
          <label>نوع المهمة</label><br/>
          <select id="filterTaskType" onchange="renderTasks()">
            <option value="">الكل</option>
          </select>
        </div>
        <div>
          <label>تصنيف المنتج</label><br/>
          <select id="filterCategory" onchange="renderTasks()">
            <option value="">الكل</option>
          </select>
        </div>
      </div>

      <div style="max-height:calc(100vh - 170px);overflow-y:auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>كود الموظف</th>
              <th>اسم الموظف</th>
              <th>نوع المهمة</th>
              <th>كود المنتج</th>
              <th>التصنيف</th>
              <th>تاريخ المهمة</th>
              <th>حالة التدقيق</th>
              <th>نقاط الجودة</th>
            </tr>
          </thead>
          <tbody id="tasksBody"></tbody>
        </table>
      </div>
    </div>

    <!-- اللوحة الجانبية -->
    <div class="card side">
      <h2>تفاصيل التدقيق</h2>
      <div id="auditDetails">
        <div>اختر مهمة من الجدول لعرض التفاصيل.</div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzun10zsjO4I2xhhvo_j09n9QL6Y_q0ssJ9wisGfK7f1Q8ORcbEe3vjqYCZ5MSDp_3I/exec";

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload })
      });
      const text = await res.text();
      return JSON.parse(text);
    }

    let user = null;
    let allTasks = [];
    let currentTaskId = null;
    let currentQualityRules = [];
    let currentTaskObj = null;

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    // --- الأدوار والتنقل ---
    function hasRole(code) {
      if (!user || !user.role) return false;
      const rolesText = user.role.toString().toUpperCase();
      return rolesText.includes(code);
    }

    function renderNav(activeCode) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

const links = [
  { code: "EMP",     label: "واجهة الموظف",   href: "employee.html" },
  { code: "EMP",     label: "أفكار الموظف",   href: "ideas.html" },
  { code: "AUDITOR", label: "لوحة المدقق",   href: "auditor.html" },
  { code: "EVALUATOR", label: "واجهة التقييم", href: "evaluator.html" },
  { code: "ADMIN",   label: "لوحة الإدارة",  href: "admin.html" },
  { code: "ADMIN",   label: "إدارة الأفكار", href: "ideas_admin.html" }
];


      links.forEach(item => {
        if (hasRole(item.code)) {
          const btn = document.createElement("button");
          btn.textContent = item.label;
          if (activeCode === item.code) btn.classList.add("active");
          btn.onclick = () => {
            if (window.location.pathname.endsWith(item.href)) return;
            window.location.href = item.href;
          };
          container.appendChild(btn);
        }
      });
    }
    // ----------------------

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);
      document.getElementById("audName").textContent = user.name + " (" + user.role + ")";
      renderNav("AUDITOR");

      initMonthFilter();
      loadTasksFromServer();
    }

    function initMonthFilter() {
      const sel = document.getElementById("filterMonth");
      const now = new Date();
      for (let i = 0; i < 6; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const y = d.getFullYear();
        const m = ('0' + (d.getMonth() + 1)).slice(-2);
        const key = y + "-" + m;
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        sel.appendChild(opt);
      }
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "كل الأشهر";
      sel.insertBefore(allOpt, sel.firstChild);
      sel.value = "";
    }

    async function loadTasksFromServer() {
      const tbody = document.getElementById("tasksBody");
      tbody.innerHTML = '<tr><td colspan="9">...جاري التحميل</td></tr>';
      try {
        const list = await callApi("getTasksForAudit", { filters: {} });
        allTasks = list || [];
        buildFilterLists();
        renderTasks();
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="9">خطأ في تحميل المهام</td></tr>';
      }
    }

    function buildFilterLists() {
      const empSel = document.getElementById("filterEmployee");
      const typeSel = document.getElementById("filterTaskType");
      const catSel = document.getElementById("filterCategory");

      empSel.innerHTML = '<option value="">الكل</option>';
      typeSel.innerHTML = '<option value="">الكل</option>';
      catSel.innerHTML = '<option value="">الكل</option>';

      const empSet = new Set();
      const typeSet = new Set();
      const catSet = new Set();

      allTasks.forEach(t => {
        if (t.EmployeeName) empSet.add(t.EmployeeName + '|' + t.EmployeeCode);
        if (t.TaskType) typeSet.add(t.TaskType);
        if (t.ProductCategory) catSet.add(t.ProductCategory);
      });

      empSet.forEach(v => {
        const [name, code] = v.split('|');
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = name + ' (' + code + ')';
        empSel.appendChild(opt);
      });

      typeSet.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        typeSel.appendChild(opt);
      });

      catSet.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        catSel.appendChild(opt);
      });
    }

    function renderTasks() {
      const tbody = document.getElementById("tasksBody");
      tbody.innerHTML = "";

      if (!allTasks.length) {
        tbody.innerHTML = '<tr><td colspan="9">لا توجد مهام</td></tr>';
        return;
      }

      const monthVal = document.getElementById("filterMonth").value;
      const statusVal = document.getElementById("filterStatus").value;
      const empVal = document.getElementById("filterEmployee").value;
      const typeVal = document.getElementById("filterTaskType").value;
      const catVal = document.getElementById("filterCategory").value;

      const filtered = allTasks.filter(t => {
        if (monthVal) {
          if (!t.TaskDate) return false;
          const d = new Date(t.TaskDate);
          const key = d.getFullYear() + '-' + ('0'+(d.getMonth()+1)).slice(-2);
          if (key !== monthVal) return false;
        }

        if (statusVal === 'OPEN') {
          if (t.AuditStatus === 'تم التدقيق') return false;
        } else if (
          statusVal === 'غير مدقق' ||
          statusVal === 'يحتاج تعديل' ||
          statusVal === 'تم التدقيق' ||
          statusVal === 'مرفوض'
        ) {
          if (t.AuditStatus !== statusVal) return false;
        }

        if (empVal && t.EmployeeCode !== empVal) return false;
        if (typeVal && t.TaskType !== typeVal) return false;
        if (catVal && t.ProductCategory !== catVal) return false;

        return true;
      });

      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="9">لا توجد مهام مطابقة للفلاتر الحالية</td></tr>';
        return;
      }

      filtered.forEach(t => {
        const tr = document.createElement("tr");
        tr.onclick = () => loadAuditDetails(t.TaskID);

        let dateTxt = "";
        if (t.TaskDate) {
          dateTxt = new Date(t.TaskDate).toLocaleDateString("ar-SY");
        }

        let badgeClass = "";
        if (t.AuditStatus === 'تم التدقيق') badgeClass = "badge badge-status-done";
        else if (t.AuditStatus === 'يحتاج تعديل') badgeClass = "badge badge-status-pending";
        else if (t.AuditStatus === 'مرفوض') badgeClass = "badge badge-status-open";
        else badgeClass = "badge badge-status-open";

        tr.innerHTML = `
          <td>${t.TaskID}</td>
          <td>${t.EmployeeCode || ""}</td>
          <td>${t.EmployeeName || ""}</td>
          <td>${t.TaskType || ""}</td>
          <td>${t.ProductCode || ""}</td>
          <td>${t.ProductCategory || ""}</td>
          <td>${dateTxt}</td>
          <td><span class="${badgeClass}">${t.AuditStatus || "غير مدقق"}</span></td>
          <td>${t.QualityEarned || 0}/${t.QualityPossible || 0}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadAuditDetails(taskId) {
      currentTaskId = taskId;
      const container = document.getElementById("auditDetails");
      container.innerHTML = "...جاري التحميل";
      try {
        const res = await callApi("getAuditDetails", { taskId });
        if (!res.success) {
          container.textContent = "لم يتم العثور على المهمة";
          return;
        }
        currentQualityRules = res.qualityRules || [];
        currentTaskObj = res.task;
        const p = res.product;

        let html = "";
        html += `<div><strong>الموظف:</strong> ${res.task.EmployeeName || ""} (${res.task.EmployeeCode || ""})</div>`;
        html += `<div><strong>تاريخ المهمة:</strong> ${res.task.TaskDate ? new Date(res.task.TaskDate).toLocaleDateString("ar-SY") : ""}</div>`;
        html += `<div><strong>نوع المهمة:</strong> ${res.task.TaskType || ""}</div>`;
        html += `<div><strong>كود المنتج:</strong> ${res.task.ProductCode || ""}</div>`;
        html += `<div><strong>تصنيف المنتج:</strong> ${res.task.ProductCategory || ""}</div>`;

        html += `<div><strong>تنفيذ ملاحظات التدقيق:</strong> ${
          res.task.EmployeeFollowUp === 'YES'
            ? 'نعم'
            : res.task.EmployeeFollowUp === 'NO'
            ? 'لا'
            : 'غير محدد'
        }</div>`;

        if (p) {
          html += `<hr><div><strong>المنتج:</strong> ${p.ProductName || ""} (${p.ProductCode || ""})</div>`;
          if (p.ProductURL) {
            html += `<div><strong>رابط المنتج:</strong> <a href="${p.ProductURL}" target="_blank">فتح في تبويب جديد</a></div>`;
            html += `<iframe src="${p.ProductURL}"></iframe>`;
          }
        }

        html += `<hr><div><strong>بنود الجودة:</strong></div>`;
        if (!currentQualityRules.length) {
          html += `<div>لا توجد قواعد جودة لهذا المنتج / هذه المهمة.</div>`;
        } else {
          html += `<div id="rulesContainer">`;
          currentQualityRules.forEach((r, idx) => {
            html += `
              <div class="rule-line">
                <div class="rule-desc">${r.Description}</div>
                <div class="rule-pts">${r.Points} نقطة</div>
                <div>
                  <select class="rule-select" data-rule-index="${idx}" onchange="updateQualityPreview()">
                    <option value="none">لا ينطبق</option>
                    <option value="correct">صح</option>
                    <option value="wrong">خطأ</option>
                  </select>
                </div>
              </div>
            `;
          });
          html += `</div>`;
        }

        html += `
          <div class="quality-summary" id="qualitySummary">
            مجموع النقاط: 0 / 0 (0%)
          </div>

          <label>ملاحظات المدقق للموظف</label>
          <textarea id="audNotes">${res.task.AuditorNotes || ""}</textarea>

          <label>حالة التدقيق</label>
          <select id="audStatus">
            <option value="تم التدقيق"${res.task.AuditStatus === 'تم التدقيق' ? ' selected' : ''}>تم التدقيق</option>
            <option value="يحتاج تعديل"${res.task.AuditStatus === 'يحتاج تعديل' ? ' selected' : ''}>يحتاج تعديل</option>
            <option value="غير مدقق"${res.task.AuditStatus === 'غير مدقق' ? ' selected' : ''}>غير مدقق</option>
            <option value="مرفوض"${res.task.AuditStatus === 'مرفوض' ? ' selected' : ''}>مرفوض</option>
          </select>

          <button onclick="saveAuditClick()">حفظ التدقيق</button>
          <div style="margin-top:4px;font-size:0.8rem;color:#0a7;" id="audMsg"></div>
        `;

        container.innerHTML = html;
        updateQualityPreview();

      } catch (err) {
        console.error(err);
        container.textContent = "خطأ في تحميل تفاصيل التدقيق";
      }
    }

    function updateQualityPreview() {
      const summary = document.getElementById("qualitySummary");
      if (!summary || !currentQualityRules.length) return;

      const selects = document.querySelectorAll("#rulesContainer select");
      let totalPossible = 0;
      let totalEarned = 0;

      selects.forEach(sel => {
        const idx = Number(sel.getAttribute("data-rule-index"));
        const r = currentQualityRules[idx];
        const pts = Number(r.Points) || 0;

        totalPossible += pts;
        if (sel.value === 'correct') {
          totalEarned += pts;
        }
      });

      let percent = 0;
      if (totalPossible > 0) percent = (totalEarned / totalPossible) * 100;

      summary.textContent = `مجموع النقاط: ${totalEarned} / ${totalPossible} (${percent.toFixed(1)}%)`;
    }

    async function saveAuditClick() {
      const msg = document.getElementById("audMsg");
      msg.textContent = "...جاري الحفظ";

      const selects = document.querySelectorAll("#rulesContainer select");
      const results = [];
      selects.forEach(sel => {
        const idx = Number(sel.getAttribute("data-rule-index"));
        const r = currentQualityRules[idx];
        results.push({
          ruleId: r.RuleID,
          status: sel.value,
          points: r.Points
        });
      });

      const notes = document.getElementById("audNotes").value;
      const status = document.getElementById("audStatus").value;

      try {
        const res = await callApi("saveAudit", {
          taskId: currentTaskId,
          ruleResults: results,
          notes,
          status
        });
        if (res.success) {
          msg.textContent = `تم الحفظ. نقاط الجودة: ${res.totalEarned}/${res.totalPossible} (${res.percent.toFixed(1)}%)`;
          const t = allTasks.find(x => x.TaskID === currentTaskId);
          if (t) {
            t.AuditStatus = status;
            t.QualityEarned = res.totalEarned;
            t.QualityPossible = res.totalPossible;
          }
          renderTasks();
        } else {
          msg.textContent = "فشل الحفظ";
        }
      } catch (err) {
        console.error(err);
        msg.textContent = "خطأ في حفظ التدقيق";
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
