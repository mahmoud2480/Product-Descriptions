<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ - Ø¬ÙŠ Ø³ØªÙˆØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary: #0d6efd;
      --primary-dark: #0a58ca;
      --bg: #f4f7fb;
      --card: #ffffff;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      font-family: "Cairo", system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #222;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: #fff;
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }

    header .subtitle {
      margin: 0;
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .nav-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.8rem;
    }

    .user-pill {
      background: rgba(255,255,255,0.12);
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .nav-buttons a {
      text-decoration: none;
    }

    .nav-buttons button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .nav-buttons button.primary {
      background: #fff;
      color: var(--primary-dark);
      font-weight: 600;
    }

    main {
      max-width: 1200px;
      margin: 16px auto;
      padding: 0 10px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      padding: 12px 14px;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h2 span.icon {
      font-size: 1.1rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 700px) {
      .form-grid,
      .form-grid-2 {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #444;
    }

    input[type="date"],
    input[type="text"],
    input[type="month"],
    select,
    textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid #d0d7e2;
      font-size: 0.9rem;
      outline: none;
      background: #f9fbff;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.1);
      background: #fff;
    }

    .inline {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    button.btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.btn-primary {
      background: var(--primary);
      color: #fff;
    }

    button.btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .small-note {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .status-bar {
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .status-bar span {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .status-bar .ok {
      background: #dcfce7;
      color: #166534;
    }

    .status-bar .error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-bar .info {
      background: #e0f2fe;
      color: #075985;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      vertical-align: middle;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
      font-size: 0.8rem;
    }

    tr:hover td {
      background: #f9fafb;
    }

    .badge {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #eef2ff;
      color: #3730a3;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      max-height: 220px;
      overflow: auto;
    }

    .summary-box h3 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      padding: 2px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-name {
      font-weight: 500;
    }

    .summary-count {
      font-weight: 600;
    }

    .summary-percent {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eef2ff;
      color: #3730a3;
    }

    .chip.total {
      background: #dcfce7;
      color: #166534;
      font-weight: 600;
    }

  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div>
        <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ - Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
        <p class="subtitle">ØªØ³Ø¬ÙŠÙ„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</p>
      </div>
      <div class="nav-right">
        <a href="index.html" style="color:#fff; font-size:0.8rem; text-decoration:none;">
          â¬… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </a>
        <div class="user-pill" id="empInfo"></div>
      </div>
    </div>

    <!-- ğŸ”¹ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„ÙƒÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª -->
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <main>
    <!-- ğŸ”¹ Ø¨Ø·Ø§Ù‚Ø© ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£ Ø¬Ø¯ÙŠØ¯ -->
    <section class="card">
      <h2><span class="icon">ğŸ“</span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£ Ø¬Ø¯ÙŠØ¯</h2>

      <form id="errorForm">
        <div class="form-grid">
          <div>
            <label for="requestDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label>
            <input type="date" id="requestDate" name="requestDate" />
          </div>

          <div>
            <label for="store">Ø§Ù„Ù…ØªØ¬Ø±</label>
            <select id="store" name="store">
              <option value="">Ø§Ø®ØªØ±...</option>
              <option value="YourstoreQ8">YourstoreQ8</option>
              <option value="GstoreQ8">GstoreQ8</option>
              <option value="TnateeshQ8">TnateeshQ8</option>
            </select>
          </div>

          <div>
            <label for="orderNumber">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
            <input type="text" id="orderNumber" name="orderNumber" placeholder="Ù…Ø«Ø§Ù„: 123456" />
          </div>

          <div>
            <label for="errorExecutor">Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£ (Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù)</label>
            <input type="text" id="errorExecutor" name="errorExecutor" placeholder="Ù…Ø«Ø§Ù„: A8" />
          </div>

          <div>
            <label for="errorType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</label>
            <select id="errorType" name="errorType">
              <option value="">Ø§Ø®ØªØ±...</option>
              <option value="ØªÙƒÙˆÙŠØ¯ ÙˆØªÙ†Ø¸ÙŠÙ…">ØªÙƒÙˆÙŠØ¯ ÙˆØªÙ†Ø¸ÙŠÙ…</option>
              <option value="ØªØ¬Ù‡ÙŠØ²/ØªØºÙ„ÙŠÙ">ØªØ¬Ù‡ÙŠØ²/ØªØºÙ„ÙŠÙ</option>
              <option value="Ø´Ø­Ù† ÙˆØªØ³Ù„ÙŠÙ…">Ø´Ø­Ù† ÙˆØªØ³Ù„ÙŠÙ…</option>
              <option value="Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª">Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª</option>
              <option value="Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡">Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡</option>
              <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>

          <div>
            <label for="recordedBy">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£</label>
            <input type="text" id="recordedBy" name="recordedBy" placeholder="Ù…Ø«Ø§Ù„: A3 Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="details">Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
          <textarea id="details" name="details" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ù…Ø®ØªØµØ± ÙˆÙˆØ§Ø¶Ø­ Ù„Ù„Ø®Ø·Ø£..."></textarea>
        </div>

        <div class="inline" style="margin-top:10px; justify-content: space-between;">
          <div class="inline" style="gap:6px;">
            <button type="submit" class="btn btn-primary" id="btnSave">
              ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø£
            </button>
            <button type="button" class="btn btn-secondary" id="btnResetForm">
              ğŸ§¹ ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            </button>
          </div>
          <p class="small-note">
            ÙŠØªÙ… Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø¹Ù…ÙˆØ¯ "Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ" ÙÙŠ Ø´ÙŠØª <b>SupportErrors</b>.
          </p>
        </div>

        <div class="status-bar" id="formStatus"></div>
      </form>
    </section>

    <!-- ğŸ”¹ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <section class="card">
      <h2><span class="icon">ğŸ“Š</span>ØªÙ‚Ø±ÙŠØ± Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h2>

      <!-- ÙÙ„Ø§ØªØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
      <div class="form-grid-2" style="margin-bottom:10px;">
        <div>
          <label for="filterMonth">Ø§Ù„Ø´Ù‡Ø±</label>
          <input type="month" id="filterMonth" />
          <p class="small-note">ÙŠØªÙ… Ø§Ù„ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨"</p>
        </div>

        <div>
          <label for="filterStore">Ø§Ù„Ù…ØªØ¬Ø±</label>
          <input type="text" id="filterStore" placeholder="Ù…Ø«Ø§Ù„: GstoreQ8 Ø£Ùˆ ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙƒÙ„" />
        </div>

        <div>
          <label for="filterErrorType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</label>
          <input type="text" id="filterErrorType" placeholder="Ù…Ø«Ø§Ù„: ØªØ¬Ù‡ÙŠØ²/ØªØºÙ„ÙŠÙ Ø£Ùˆ ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹" />
        </div>

        <div>
          <label for="filterExecutor">Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£</label>
          <input type="text" id="filterExecutor" placeholder="ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" />
        </div>

        <div>
          <label for="filterRecordedBy">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£</label>
          <input type="text" id="filterRecordedBy" placeholder="ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" />
        </div>
      </div>

      <div class="inline" style="justify-content: space-between; margin-bottom:8px;">
        <div class="inline" style="gap:6px;">
          <button type="button" class="btn btn-primary" id="btnLoadReport">
            ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          </button>
          <button type="button" class="btn btn-secondary" id="btnClearFilters">
            â™» ØªØµÙÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ±
          </button>
        </div>

        <div class="chips-row" id="reportChips">
          <!-- ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>
      </div>

      <div class="status-bar" id="reportStatus"></div>

      <!-- Ù…Ù„Ø®ØµØ§Øª -->
      <div class="summary-grid">
        <div class="summary-box">
          <h3>ğŸ‘¤ Ø­Ø³Ø¨ Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£</h3>
          <div id="byExecutorBox"></div>
        </div>

        <div class="summary-box">
          <h3>âš™ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</h3>
          <div id="byTypeBox"></div>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø§Ù„Ø´Ù‡Ø±</th>
              <th>Ø§Ù„Ù…ØªØ¬Ø±</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</th>
              <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£</th>
              <th>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
            </tr>
          </thead>
          <tbody id="reportTableBody">
            <!-- Ø§Ù„ØµÙÙˆÙ Ù‡Ù†Ø§ -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ğŸ§‘â€ğŸ’¼ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    const EMP = JSON.parse(localStorage.getItem("employeeData") || "{}");
    const empInfo = document.getElementById("empInfo");

    // ğŸ›¡ï¸ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
    const roleUpper = (EMP.role || EMP.roleCode || "").toUpperCase();
    const ALLOWED_ROLES = ["ADMIN","AUDITOR","AUDITOR_EXTENDED","SUPPORT","EVALUATOR"];

    if (!ALLOWED_ROLES.includes(roleUpper)) {
      alert("ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.");
      window.location.href = "login.html"; 
    }

    // âœ… ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Web App Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø³ÙƒØ±Ø¨Øª
    const API_URL = "https://script.google.com/macros/s/XXXXXXXXXXXX/exec";

    const form = document.getElementById("errorForm");
    const formStatus = document.getElementById("formStatus");
    const btnSave = document.getElementById("btnSave");
    const btnResetForm = document.getElementById("btnResetForm");

    const filterMonth = document.getElementById("filterMonth");
    const filterStore = document.getElementById("filterStore");
    const filterErrorType = document.getElementById("filterErrorType");
    const filterExecutor = document.getElementById("filterExecutor");
    const filterRecordedBy = document.getElementById("filterRecordedBy");

    const btnLoadReport = document.getElementById("btnLoadReport");
    const btnClearFilters = document.getElementById("btnClearFilters");
    const reportStatus = document.getElementById("reportStatus");
    const reportChips = document.getElementById("reportChips");
    const reportTableBody = document.getElementById("reportTableBody");
    const byExecutorBox = document.getElementById("byExecutorBox");
    const byTypeBox = document.getElementById("byTypeBox");

    function setFormStatus(message, type) {
      if (!message) {
        formStatus.innerHTML = "";
        return;
      }
      let cls = "info";
      if (type === "ok") cls = "ok";
      if (type === "error") cls = "error";
      formStatus.innerHTML = `<span class="${cls}">${message}</span>`;
    }

    function setReportStatus(message, type) {
      if (!message) {
        reportStatus.innerHTML = "";
        return;
      }
      let cls = "info";
      if (type === "ok") cls = "ok";
      if (type === "error") cls = "error";
      reportStatus.innerHTML = `<span class="${cls}">${message}</span>`;
    }

    function formatDateShort(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}/${m}/${day}`;
    }

    function formatDateTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}/${m}/${day} - ${hh}:${mm}`;
    }

    // ğŸ§­ Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

      const ROLE = (EMP.role || EMP.roleCode || "").toUpperCase();
      if (!ROLE) return;

      // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©
      const links = [
        { code: "EMP",              label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù",     href: "employee.html" },
        { code: "EMP",              label: "Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù",     href: "ideas.html" },
        { code: "AUDITOR_EXTENDED", label: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚",      href: "auditor.html" },
        { code: "EVALUATOR",        label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",    href: "evaluator.html" },
        { code: "ADMIN",            label: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",     href: "admin.html" },
        { code: "ADMIN",            label: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±",    href: "ideas_admin.html" },
        { code: "EVALUATOR",        label: "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ",  href: "tests.html" },
        { code: "AUDITOR_EXTENDED", label: "ØªÙ‚Ø§Ø±ÙŠØ±",           href: "reports.html" },
        { code: "SUPPORT",          label: "Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ",      href: "support.html" }
      ];

      const allowedCodes = new Set();

      switch (ROLE) {
        case "ADMIN":
          ["EMP","AUDITOR_EXTENDED","EVALUATOR","ADMIN","SUPPORT"].forEach(c => allowedCodes.add(c));
          break;
        case "AUDITOR_EXTENDED":
        case "AUDITOR":
          ["EMP","AUDITOR_EXTENDED"].forEach(c => allowedCodes.add(c));
          break;
        case "EVALUATOR":
          ["EMP","EVALUATOR"].forEach(c => allowedCodes.add(c));
          break;
        case "SUPPORT":
          ["SUPPORT"].forEach(c => allowedCodes.add(c));
          break;
        case "EMP":
        case "EMPLOYEE":
          ["EMP"].forEach(c => allowedCodes.add(c));
          break;
        default:
          return;
      }

      links
        .filter(link => allowedCodes.has(link.code))
        .forEach(link => {
          const a = document.createElement("a");
          a.href = link.href;

          const btn = document.createElement("button");
          btn.type = "button";

          if (activeHref && activeHref === link.href) {
            btn.className = "primary";
          }

          btn.textContent = link.label;
          a.appendChild(btn);
          container.appendChild(a);
        });
    }

    // ğŸŸ¦ Ø¥Ø±Ø³Ø§Ù„ Ø®Ø·Ø£ Ø¬Ø¯ÙŠØ¯
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setFormStatus("", "info");

      const requestDate = document.getElementById("requestDate").value;
      const store = document.getElementById("store").value;
      const orderNumber = document.getElementById("orderNumber").value.trim();
      const errorExecutor = document.getElementById("errorExecutor").value.trim();
      const errorType = document.getElementById("errorType").value;
      const recordedBy = document.getElementById("recordedBy").value.trim();
      const details = document.getElementById("details").value.trim();

      if (!store || !errorType || !errorExecutor) {
        setFormStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…ØªØ¬Ø± + Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£ + Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.", "error");
        return;
      }

      btnSave.disabled = true;
      setFormStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...", "info");

      const payload = {
        requestDate: requestDate || null,
        store,
        orderNumber,
        errorExecutor,
        errorType,
        details,
        recordedBy
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "addSupportError",
            payload
          })
        });

        const data = await res.json();
        if (data && data.success) {
          setFormStatus("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø£ Ø¨Ù†Ø¬Ø§Ø­ âœ…", "ok");
          document.getElementById("details").value = "";
          loadReport(false);
        } else {
          console.error(data);
          setFormStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
        }
      } catch (err) {
        console.error(err);
        setFormStatus("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· API.", "error");
      } finally {
        btnSave.disabled = false;
      }
    });

    btnResetForm.addEventListener("click", () => {
      const orderNumber = document.getElementById("orderNumber");
      const errorExecutor = document.getElementById("errorExecutor");
      const details = document.getElementById("details");
      const store = document.getElementById("store");
      const errorType = document.getElementById("errorType");

      orderNumber.value = "";
      errorExecutor.value = "";
      details.value = "";
      store.value = "";
      errorType.value = "";
      setFormStatus("", "info");
    });

    // ğŸŸ¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    async function loadReport(showMessage = true) {
      setReportStatus(showMessage ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±..." : "", "info");
      reportTableBody.innerHTML = "";
      byExecutorBox.innerHTML = "";
      byTypeBox.innerHTML = "";
      reportChips.innerHTML = "";

      let monthKey = "";
      if (filterMonth.value) {
        monthKey = filterMonth.value;
      }

      const filters = {
        monthKey,
        store: filterStore.value.trim() || null,
        errorType: filterErrorType.value.trim() || null,
        errorExecutor: filterExecutor.value.trim() || null,
        recordedBy: filterRecordedBy.value.trim() || null
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "getSupportErrors",
            payload: { filters }
          })
        });

        const data = await res.json();
        if (!data || !data.success) {
          console.error(data);
          setReportStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.", "error");
          return;
        }

        const rows = data.rows || [];
        const total = data.total || rows.length || 0;
        const byExecutor = data.byExecutor || [];
        const byType = data.byType || [];

        const totalChip = document.createElement("span");
        totalChip.className = "chip total";
        totalChip.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: ${total}`;
        reportChips.appendChild(totalChip);

        const filtersMap = [];

        if (monthKey) filtersMap.push({ label: "Ø§Ù„Ø´Ù‡Ø±", value: monthKey });
        if (filters.store) filtersMap.push({ label: "Ø§Ù„Ù…ØªØ¬Ø±", value: filters.store });
        if (filters.errorType) filtersMap.push({ label: "Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£", value: filters.errorType });
        if (filters.errorExecutor) filtersMap.push({ label: "Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£", value: filters.errorExecutor });
        if (filters.recordedBy) filtersMap.push({ label: "Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£", value: filters.recordedBy });

        filtersMap.forEach(f => {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = `${f.label}: ${f.value}`;
          reportChips.appendChild(chip);
        });

        if (rows.length === 0) {
          reportTableBody.innerHTML = `
            <tr>
              <td colspan="9" style="text-align:center; padding:10px; color:#6b7280;">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
              </td>
            </tr>
          `;
        } else {
          const frag = document.createDocumentFragment();
          rows.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${formatDateShort(r.RequestDate)}</td>
              <td>${r.MonthKey || ""}</td>
              <td>${r.Store || ""}</td>
              <td>${r.OrderNumber || ""}</td>
              <td>${r.ErrorExecutor || ""}</td>
              <td>${r.ErrorType || ""}</td>
              <td>${r.Details || ""}</td>
              <td>${r.RecordedBy || ""}</td>
              <td>${formatDateTime(r.Timestamp)}</td>
            `;
            frag.appendChild(tr);
          });
          reportTableBody.appendChild(frag);
        }

        if (byExecutor.length === 0) {
          byExecutorBox.innerHTML = `<p class="small-note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹ Ù…ØªØ§Ø­.</p>`;
        } else {
          const fragExec = document.createDocumentFragment();
          byExecutor.forEach(item => {
            const div = document.createElement("div");
            div.className = "summary-row";
            div.innerHTML = `
              <span class="summary-name">${item.name}</span>
              <span>
                <span class="summary-count">${item.count}</span>
                <span class="summary-percent">(${item.percentFrom100.toFixed(1)}%)</span>
              </span>
            `;
            fragExec.appendChild(div);
          });
          byExecutorBox.appendChild(fragExec);
        }

        if (byType.length === 0) {
          byTypeBox.innerHTML = `<p class="small-note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹ Ù…ØªØ§Ø­.</p>`;
        } else {
          const fragType = document.createDocumentFragment();
          byType.forEach(item => {
            const div = document.createElement("div");
            div.className = "summary-row";
            div.innerHTML = `
              <span class="summary-name">${item.type}</span>
              <span>
                <span class="summary-count">${item.count}</span>
                <span class="summary-percent">(${item.percentFrom100.toFixed(1)}%)</span>
              </span>
            `;
            fragType.appendChild(div);
          });
          byTypeBox.appendChild(fragType);
        }

        setReportStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­. Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${total}`, "ok");
      } catch (err) {
        console.error(err);
        setReportStatus("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· API.", "error");
      }
    }

    btnLoadReport.addEventListener("click", () => loadReport(true));

    btnClearFilters.addEventListener("click", () => {
      filterMonth.value = "";
      filterStore.value = "";
      filterErrorType.value = "";
      filterExecutor.value = "";
      filterRecordedBy.value = "";
      loadReport(true);
    });

    // ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© + ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù + Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„
    window.addEventListener("DOMContentLoaded", () => {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      filterMonth.value = `${y}-${m}`;
      loadReport(false);

      if (empInfo && (EMP.employeeCode || EMP.name)) {
        empInfo.textContent = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${
          EMP.employeeCode ? EMP.employeeCode + " - " : ""
        }${EMP.name || ""} (${EMP.role || EMP.roleCode || ""})`;
      }

      const recInput = document.getElementById("recordedBy");
      if (recInput && (EMP.employeeCode || EMP.name)) {
        recInput.value = `${
          EMP.employeeCode ? EMP.employeeCode : ""
        }${EMP.employeeCode && EMP.name ? " - " : ""}${
          EMP.name ? EMP.name : ""
        }`;
        recInput.readOnly = true;
      }

      // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ + ØªÙ…ÙŠÙŠØ² ØµÙØ­Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      renderNav("support.html");
    });
  </script>
</body>
</html>
