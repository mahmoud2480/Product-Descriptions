<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ - Ø¬ÙŠ Ø³ØªÙˆØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ù„Ùˆ Ø­Ø¨ÙŠØª ØªØªØ®Ù„Øµ Ù…Ù† Ø®Ø·Ø£ Ø§Ù„Ù€ faviconØŒ Ø¶Ø¹ Ø£ÙŠ ØµÙˆØ±Ø© ØµØºÙŠØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ù„Ù -->
  <!-- Ø£Ùˆ ØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø³Ø§Ø± Ù‡Ù†Ø§ Ø¥Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„Ø§Ù‹ -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <style>
    :root {
      --primary: #0d6efd;
      --primary-dark: #0a58ca;
      --bg: #f4f7fb;
      --card: #ffffff;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      font-family: "Cairo", system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #222;
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: #fff;
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }

    header .subtitle {
      margin: 0;
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .nav-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.8rem;
    }

    .user-pill {
      background: rgba(255,255,255,0.12);
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .nav-buttons button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .nav-buttons button.active {
      background: #fff;
      color: var(--primary-dark);
      font-weight: 600;
    }

    main {
      max-width: 1200px;
      margin: 16px auto;
      padding: 0 10px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      padding: 12px 14px;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h2 span.icon {
      font-size: 1.1rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 700px) {
      .form-grid,
      .form-grid-2 {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #444;
    }

    input[type="date"],
    input[type="text"],
    input[type="month"],
    select,
    textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid #d0d7e2;
      font-size: 0.9rem;
      outline: none;
      background: #f9fbff;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.1);
      background: #fff;
    }

    .inline {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    button.btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.btn-primary {
      background: var(--primary);
      color: #fff;
    }

    button.btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .small-note {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .status-bar {
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .status-bar span {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .status-bar .ok {
      background: #dcfce7;
      color: #166534;
    }

    .status-bar .error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-bar .info {
      background: #e0f2fe;
      color: #075985;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      vertical-align: middle;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
      font-size: 0.8rem;
    }

    tr:hover td {
      background: #f9fafb;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      max-height: 220px;
      overflow: auto;
    }

    .summary-box h3 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      padding: 2px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-name {
      font-weight: 500;
    }

    .summary-count {
      font-weight: 600;
    }

    .summary-percent {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eef2ff;
      color: #3730a3;
    }

    .chip.total {
      background: #dcfce7;
      color: #166534;
      font-weight: 600;
    }

    .table-actions-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 2px 4px;
      border-radius: 6px;
    }

    .table-actions-btn.edit-btn {
      color: #0d6efd;
    }

    .table-actions-btn.delete-btn {
      color: #b91c1c;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div>
        <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ - Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
        <p class="subtitle">ØªØ³Ø¬ÙŠÙ„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</p>
      </div>
      <div class="nav-right">
        <a href="index.html" style="color:#fff; font-size:0.8rem; text-decoration:none;">
          â¬… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </a>
        <div class="user-pill" id="empInfo"></div>
      </div>
    </div>

    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <main>
    <!-- Ø¨Ø·Ø§Ù‚Ø© ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£ -->
    <section class="card">
      <h2><span class="icon">ğŸ“</span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£ Ø¬Ø¯ÙŠØ¯</h2>

      <form id="errorForm">
        <input type="hidden" id="editKey" />

        <div class="form-grid">
          <div>
            <label for="requestDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label>
            <input type="date" id="requestDate" name="requestDate" />
          </div>

          <div>
            <label for="store">Ø§Ù„Ù…ØªØ¬Ø±</label>
            <select id="store" name="store">
              <option value="">Ø§Ø®ØªØ±...</option>
              <option value="YourstoreQ8">YourstoreQ8</option>
              <option value="GstoreQ8">GstoreQ8</option>
              <option value="TnateeshQ8">TnateeshQ8</option>
            </select>
          </div>

          <div>
            <label for="orderNumber">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
            <input type="text" id="orderNumber" name="orderNumber" placeholder="Ù…Ø«Ø§Ù„: 123456" />
          </div>

          <div>
            <label for="errorExecutor">Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£ (Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù)</label>
            <input type="text" id="errorExecutor" name="errorExecutor" placeholder="Ù…Ø«Ø§Ù„: A8" />
          </div>

          <div>
            <label for="errorType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</label>
            <select id="errorType" name="errorType">
              <option value="">Ø§Ø®ØªØ±...</option>
              <option value="ØªÙƒÙˆÙŠØ¯ Ùˆ ØªÙ†Ø¸ÙŠÙ…">ØªÙƒÙˆÙŠØ¯ Ùˆ ØªÙ†Ø¸ÙŠÙ…</option>
              <option value="ØªØ¬Ù‡ÙŠØ²">ØªØ¬Ù‡ÙŠØ²</option>
              <option value="Ø±ÙØ¹ ÙˆØªÙˆØµÙŠÙ">Ø±ÙØ¹ ÙˆØªÙˆØµÙŠÙ</option>
              <option value="Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡">Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡</option>
              <option value="Ù‚Ø³Ù… Ø§Ù„Ù…ÙŠØ¯ÙŠØ§">Ù‚Ø³Ù… Ø§Ù„Ù…ÙŠØ¯ÙŠØ§</option>
              <option value="Ø´Ø­Ù† Ùˆ ØªØ³Ù„ÙŠÙ…">Ø´Ø­Ù† Ùˆ ØªØ³Ù„ÙŠÙ…</option>
              <option value="ØªØ§Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†">ØªØ§Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†</option>
              <option value="Ù†Ø§Ù‚Øµ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†">Ù†Ø§Ù‚Øµ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†</option>
              <option value="Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨Ø±ØºØ¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨Ø±ØºØ¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
              <option value="Ø§Ø®Ø±Ù‰">Ø§Ø®Ø±Ù‰</option>
            </select>
          </div>

          <div>
            <label for="recordedBy">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£</label>
            <input type="text" id="recordedBy" name="recordedBy" placeholder="Ù…Ø«Ø§Ù„: A3 Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="details">Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
          <textarea id="details" name="details" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ù…Ø®ØªØµØ± ÙˆÙˆØ§Ø¶Ø­ Ù„Ù„Ø®Ø·Ø£..."></textarea>
        </div>

        <div class="inline" style="margin-top:10px; justify-content: space-between;">
          <div class="inline" style="gap:6px;">
            <button type="submit" class="btn btn-primary" id="btnSave">
              ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø£
            </button>
            <button type="button" class="btn btn-secondary" id="btnResetForm">
              ğŸ§¹ ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ / Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            </button>
          </div>
          <p class="small-note">
            ÙŠØªÙ… Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ ÙˆØ±Ù‚Ø© <b>SupportErrors</b>.
          </p>
        </div>

        <div class="status-bar" id="formStatus"></div>
      </form>
    </section>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <section class="card">
      <h2><span class="icon">ğŸ“Š</span>ØªÙ‚Ø±ÙŠØ± Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h2>

      <div class="form-grid-2" style="margin-bottom:10px;">
        <div>
          <label for="filterMonth">Ø§Ù„Ø´Ù‡Ø±</label>
          <input type="month" id="filterMonth" />
          <p class="small-note">ÙŠØªÙ… Ø§Ù„ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨"</p>
        </div>

        <div>
          <label for="filterStore">Ø§Ù„Ù…ØªØ¬Ø±</label>
          <select id="filterStore">
            <option value="">ÙƒÙ„ Ø§Ù„Ù…ØªØ§Ø¬Ø±</option>
            <option value="YourstoreQ8">YourstoreQ8</option>
            <option value="GstoreQ8">GstoreQ8</option>
            <option value="TnateeshQ8">TnateeshQ8</option>
          </select>
        </div>

        <div>
          <label for="filterErrorType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</label>
          <select id="filterErrorType">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            <option value="ØªÙƒÙˆÙŠØ¯ Ùˆ ØªÙ†Ø¸ÙŠÙ…">ØªÙƒÙˆÙŠØ¯ Ùˆ ØªÙ†Ø¸ÙŠÙ…</option>
            <option value="ØªØ¬Ù‡ÙŠØ²">ØªØ¬Ù‡ÙŠØ²</option>
            <option value="Ø±ÙØ¹ ÙˆØªÙˆØµÙŠÙ">Ø±ÙØ¹ ÙˆØªÙˆØµÙŠÙ</option>
            <option value="Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡">Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…ÙŠØ¯ÙŠØ§">Ù‚Ø³Ù… Ø§Ù„Ù…ÙŠØ¯ÙŠØ§</option>
            <option value="Ø´Ø­Ù† Ùˆ ØªØ³Ù„ÙŠÙ…">Ø´Ø­Ù† Ùˆ ØªØ³Ù„ÙŠÙ…</option>
            <option value="ØªØ§Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†">ØªØ§Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†</option>
            <option value="Ù†Ø§Ù‚Øµ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†">Ù†Ø§Ù‚Øµ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†</option>
            <option value="Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨Ø±ØºØ¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨Ø±ØºØ¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
            <option value="Ø§Ø®Ø±Ù‰">Ø§Ø®Ø±Ù‰</option>
          </select>
        </div>

        <div>
          <label for="filterExecutor">Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£</label>
          <select id="filterExecutor">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>

        <div>
          <label for="filterRecordedBy">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£</label>
          <select id="filterRecordedBy">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
      </div>

      <div class="inline" style="justify-content: space-between; margin-bottom:8px;">
        <div class="inline" style="gap:6px;">
          <button type="button" class="btn btn-primary" id="btnLoadReport">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          <button type="button" class="btn btn-secondary" id="btnClearFilters">â™» ØªØµÙÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>

        <div class="chips-row" id="reportChips"></div>
      </div>

      <div class="status-bar" id="reportStatus"></div>

      <div class="summary-grid">
        <div class="summary-box">
          <h3>ğŸ‘¤ Ø­Ø³Ø¨ Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£</h3>
          <div id="byExecutorBox"></div>
        </div>

        <div class="summary-box">
          <h3>âš™ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</h3>
          <div id="byTypeBox"></div>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø§Ù„Ø´Ù‡Ø±</th>
              <th>Ø§Ù„Ù…ØªØ¬Ø±</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£</th>
              <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£</th>
              <th>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="reportTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- config.js Ø§Ù„Ù…ÙˆØ­Ø¯ -->
  <script src="config.js"></script>

  <script>
    const API_URL = window.API_URL;

    async function callApi(action, payload) {
      if (!API_URL) {
        throw new Error("API_URL ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„Ù config.js");
      }
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: action, payload: payload })
      });
      const txt = await res.text();
      try {
        return JSON.parse(txt);
      } catch (e) {
        console.error("RAW API:", txt);
        throw e;
      }
    }

    let user = null;
    let lastReportRows = [];

    function loadUserFromStorage() {
      const str = localStorage.getItem("taskUser") || localStorage.getItem("employeeData");
      if (!str) {
        window.location.href = "index.html";
        return null;
      }
      user = JSON.parse(str);
      return user;
    }

    function hasRole(code) {
      if (!user || !user.role) return false;
      const rolesTextUpper = String(user.role).toUpperCase();
      const rolesTextRaw   = String(user.role);

      if (code === "AUDITOR_EXTENDED") {
        return (
          rolesTextUpper.indexOf("AUDITOR") !== -1 ||
          rolesTextUpper.indexOf("ADMIN")   !== -1 ||
          rolesTextUpper.indexOf("MANAGER") !== -1 ||
          rolesTextRaw.indexOf("Ù…Ø¯ÙŠØ±")      !== -1 ||
          rolesTextRaw.indexOf("Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù…")  !== -1 ||
          rolesTextRaw.indexOf("Ù…Ø¯Ù‚Ù‚")      !== -1
        );
      }
      return rolesTextUpper.indexOf(code) !== -1;
    }

    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

      const links = [
        { code: "EMP",              label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù",    href: "employee.html" },
        { code: "EMP",              label: "Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù",    href: "ideas.html" },
        { code: "AUDITOR_EXTENDED", label: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚",     href: "auditor.html" },
        { code: "EVALUATOR",        label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",   href: "evaluator.html" },
        { code: "EVALUATOR",        label: "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ", href: "tests.html" },
        { code: "ADMIN",            label: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",    href: "admin.html" },
        { code: "ADMIN",            label: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±",   href: "ideas_admin.html" },
        { code: "AUDITOR_EXTENDED", label: "ØªÙ‚Ø§Ø±ÙŠØ±",          href: "reports.html" },
        { code: "SUPPORT",          label: "Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ",     href: "support.html" }
      ];

      links.forEach(function(item) {
        if (!hasRole(item.code)) return;
        const btn = document.createElement("button");
        btn.textContent = item.label;
        if (activeHref === item.href) btn.classList.add("active");
        btn.onclick = function() {
          if (!window.location.pathname.endsWith(item.href)) {
            window.location.href = item.href;
          }
        };
        container.appendChild(btn);
      });
    }

    const form             = document.getElementById("errorForm");
    const formStatus       = document.getElementById("formStatus");
    const btnSave          = document.getElementById("btnSave");
    const btnResetForm     = document.getElementById("btnResetForm");
    const editKeyInput     = document.getElementById("editKey");

    const filterMonth      = document.getElementById("filterMonth");
    const filterStore      = document.getElementById("filterStore");
    const filterErrorType  = document.getElementById("filterErrorType");
    const filterExecutor   = document.getElementById("filterExecutor");
    const filterRecordedBy = document.getElementById("filterRecordedBy");
    const btnLoadReport    = document.getElementById("btnLoadReport");
    const btnClearFilters  = document.getElementById("btnClearFilters");
    const reportStatus     = document.getElementById("reportStatus");
    const reportChips      = document.getElementById("reportChips");
    const reportTableBody  = document.getElementById("reportTableBody");
    const byExecutorBox    = document.getElementById("byExecutorBox");
    const byTypeBox        = document.getElementById("byTypeBox");
    const empInfo          = document.getElementById("empInfo");

    function setFormStatus(message, type) {
      if (!message) {
        formStatus.innerHTML = "";
        return;
      }
      var cls = "info";
      if (type === "ok") cls = "ok";
      if (type === "error") cls = "error";
      formStatus.innerHTML = '<span class="' + cls + '">' + message + '</span>';
    }

    function setReportStatus(message, type) {
      if (!message) {
        reportStatus.innerHTML = "";
        return;
      }
      var cls = "info";
      if (type === "ok") cls = "ok";
      if (type === "error") cls = "error";
      reportStatus.innerHTML = '<span class="' + cls + '">' + message + '</span>';
    }

    function formatDateShort(iso) {
      if (!iso) return "";
      var d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, "0");
      var day = String(d.getDate()).padStart(2, "0");
      return y + "/" + m + "/" + day;
    }

    function formatDateTime(iso) {
      if (!iso) return "";
      var d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, "0");
      var day = String(d.getDate()).padStart(2, "0");
      var hh = String(d.getHours()).padStart(2, "0");
      var mm = String(d.getMinutes()).padStart(2, "0");
      return y + "/" + m + "/" + day + " - " + hh + ":" + mm;
    }

    function isoToInputDate(iso) {
      if (!iso) return "";
      var d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, "0");
      var day = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + day;
    }

    function updateDynamicFilterOptions(rows) {
      var execPrev = filterExecutor.value || "";
      var recPrev  = filterRecordedBy.value || "";

      var execSet = new Set();
      var recSet  = new Set();

      rows.forEach(function(r) {
        if (r.ErrorExecutor) execSet.add(r.ErrorExecutor);
        if (r.RecordedBy)    recSet.add(r.RecordedBy);
      });

      filterExecutor.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
      Array.from(execSet).sort().forEach(function(val) {
        var opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        filterExecutor.appendChild(opt);
      });
      if (execPrev && execSet.has(execPrev)) {
        filterExecutor.value = execPrev;
      }

      filterRecordedBy.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
      Array.from(recSet).sort().forEach(function(val) {
        var opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        filterRecordedBy.appendChild(opt);
      });
      if (recPrev && recSet.has(recPrev)) {
        filterRecordedBy.value = recPrev;
      }
    }

    function canUserEdit(row) {
      if (!user) return false;
      var roleStr = String(user.role || "");
      var ru = roleStr.toUpperCase();

      var isAdminRole =
        ru.indexOf("ADMIN")   !== -1 ||
        ru.indexOf("SUPPORT") !== -1 ||
        ru.indexOf("MANAGER") !== -1 ||
        roleStr.indexOf("Ù…Ø¯ÙŠØ±")      !== -1 ||
        roleStr.indexOf("Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù…")  !== -1;

      if (isAdminRole) return true;

      var rec = String(row.RecordedBy || "");
      if (user.employeeCode && rec.indexOf(user.employeeCode) !== -1) return true;
      if (user.name && rec.indexOf(user.name) !== -1) return true;

      return false;
    }

    function enterEditMode(row) {
      if (!row) return;

      editKeyInput.value = row.Timestamp || "";
      document.getElementById("requestDate").value   = isoToInputDate(row.RequestDate);
      document.getElementById("store").value         = row.Store || "";
      document.getElementById("orderNumber").value   = row.OrderNumber || "";
      document.getElementById("errorExecutor").value = row.ErrorExecutor || "";
      document.getElementById("errorType").value     = row.ErrorType || "";
      document.getElementById("details").value       = row.Details || "";

      var recInput = document.getElementById("recordedBy");
      if (recInput) {
        recInput.value = row.RecordedBy || recInput.value || "";
      }

      btnSave.textContent = "ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·Ø£";
      setFormStatus("ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØ¹Ù„. Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„.", "info");
    }

    function resetFormFields() {
      document.getElementById("requestDate").value   = "";
      document.getElementById("store").value         = "";
      document.getElementById("orderNumber").value   = "";
      document.getElementById("errorExecutor").value = "";
      document.getElementById("errorType").value     = "";
      document.getElementById("details").value       = "";
      // Ù„Ø§ Ù†ÙØ±Øº recordedBy Ù„Ø£Ù†Ù‡ ÙŠØ¹ÙƒØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    }

    function exitEditMode() {
      editKeyInput.value = "";
      btnSave.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø£";
      setFormStatus("", "info");
      resetFormFields();
    }

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      setFormStatus("", "info");

      const requestDate   = document.getElementById("requestDate").value;
      const store         = document.getElementById("store").value;
      const orderNumber   = document.getElementById("orderNumber").value.trim();
      const errorExecutor = document.getElementById("errorExecutor").value.trim();
      const errorType     = document.getElementById("errorType").value;
      const recordedBy    = document.getElementById("recordedBy").value.trim();
      const details       = document.getElementById("details").value.trim();

      const isEdit = !!editKeyInput.value;

      if (!store || !errorType || !errorExecutor) {
        setFormStatus("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…ØªØ¬Ø± + Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£ + Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.", "error");
        return;
      }

      btnSave.disabled = true;
      setFormStatus(isEdit ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„..." : "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...", "info");

      try {
        let data;
        if (isEdit) {
          data = await callApi("updateSupportError", {
            keyTimestamp: editKeyInput.value,
            requestDate: requestDate || null,
            store: store,
            orderNumber: orderNumber,
            errorExecutor: errorExecutor,
            errorType: errorType,
            details: details,
            recordedBy: recordedBy,
            currentUserCode: user ? user.employeeCode : "",
            currentUserName: user ? user.name : "",
            currentUserRole: user ? user.role : ""
          });
        } else {
          data = await callApi("addSupportError", {
            requestDate: requestDate || null,
            store: store,
            orderNumber: orderNumber,
            errorExecutor: errorExecutor,
            errorType: errorType,
            details: details,
            recordedBy: recordedBy
          });
        }

        if (data && data.success) {
          setFormStatus(
            isEdit ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø£ Ø¨Ù†Ø¬Ø§Ø­ âœ…",
            "ok"
          );
          if (isEdit) {
            exitEditMode();
          } else {
            resetFormFields();
          }
          document.getElementById("details").value = "";
          loadReport(false);
        } else {
          console.error(data);
          setFormStatus(
            data && data.message ? data.message : "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
            "error"
          );
        }
      } catch (err) {
        console.error(err);
        setFormStatus("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· API.", "error");
      } finally {
        btnSave.disabled = false;
      }
    });

    btnResetForm.addEventListener("click", function() {
      exitEditMode();
    });

    async function loadReport(showMessage) {
      if (showMessage === undefined) showMessage = true;
      setReportStatus(showMessage ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±..." : "", "info");
      reportTableBody.innerHTML = "";
      byExecutorBox.innerHTML = "";
      byTypeBox.innerHTML = "";
      reportChips.innerHTML = "";

      let monthKey = "";
      if (filterMonth.value) {
        monthKey = filterMonth.value;
      }

      const filters = {
        monthKey: monthKey,
        store:         filterStore.value      || null,
        errorType:     filterErrorType.value || null,
        errorExecutor: filterExecutor.value  || null,
        recordedBy:    filterRecordedBy.value|| null
      };

      try {
        const data = await callApi("getSupportErrors", { filters: filters });

        if (!data || !data.success) {
          console.error(data);
          setReportStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.", "error");
          return;
        }

        const rows       = data.rows || [];
        const total      = typeof data.total === "number" ? data.total : (rows.length || 0);
        const byExecutor = data.byExecutor || [];
        const byType     = data.byType || [];

        lastReportRows = rows;

        updateDynamicFilterOptions(rows);

        const totalChip = document.createElement("span");
        totalChip.className = "chip total";
        totalChip.textContent = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: " + total;
        reportChips.appendChild(totalChip);

        const filtersMap = [];
        if (monthKey)              filtersMap.push({ label: "Ø§Ù„Ø´Ù‡Ø±",      value: monthKey });
        if (filters.store)         filtersMap.push({ label: "Ø§Ù„Ù…ØªØ¬Ø±",     value: filters.store });
        if (filters.errorType)     filtersMap.push({ label: "Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£",  value: filters.errorType });
        if (filters.errorExecutor) filtersMap.push({ label: "Ù…Ù†ÙØ° Ø§Ù„Ø®Ø·Ø£", value: filters.errorExecutor });
        if (filters.recordedBy)    filtersMap.push({ label: "Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£",  value: filters.recordedBy });

        filtersMap.forEach(function(f) {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = f.label + ": " + f.value;
          reportChips.appendChild(chip);
        });

        if (rows.length === 0) {
          reportTableBody.innerHTML =
            '<tr><td colspan="10" style="text-align:center; padding:10px; color:#6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</td></tr>';
        } else {
          const frag = document.createDocumentFragment();
          rows.forEach(function(r) {
            const tr = document.createElement("tr");
            const canEditRow = canUserEdit(r);
            let actionsHtml = "";
            if (canEditRow) {
              actionsHtml =
                '<button type="button" class="table-actions-btn edit-btn">âœ ØªØ¹Ø¯ÙŠÙ„</button>' +
                '<button type="button" class="table-actions-btn delete-btn">ğŸ—‘ Ø­Ø°Ù</button>';
            }

            tr.innerHTML =
              "<td>" + formatDateShort(r.RequestDate) + "</td>" +
              "<td>" + (r.MonthKey || "") + "</td>" +
              "<td>" + (r.Store || "") + "</td>" +
              "<td>" + (r.OrderNumber || "") + "</td>" +
              "<td>" + (r.ErrorExecutor || "") + "</td>" +
              "<td>" + (r.ErrorType || "") + "</td>" +
              "<td>" + (r.Details || "") + "</td>" +
              "<td>" + (r.RecordedBy || "") + "</td>" +
              "<td>" + formatDateTime(r.Timestamp) + "</td>" +
              "<td>" + actionsHtml + "</td>";

            if (canEditRow) {
              const editBtn = tr.querySelector(".edit-btn");
              const delBtn  = tr.querySelector(".delete-btn");

              if (editBtn) {
                editBtn.addEventListener("click", function() {
                  enterEditMode(r);
                  window.scrollTo({ top: 0, behavior: "smooth" });
                });
              }

              if (delBtn) {
                delBtn.addEventListener("click", async function() {
                  const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ");
                  if (!ok) return;
                  try {
                    setReportStatus("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„...", "info");
                    const resp = await callApi("deleteSupportError", {
                      keyTimestamp: r.Timestamp,
                      currentUserCode: user ? user.employeeCode : "",
                      currentUserName: user ? user.name : "",
                      currentUserRole: user ? user.role : ""
                    });
                    if (resp && resp.success) {
                      setReportStatus("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.", "ok");
                      if (editKeyInput.value === r.Timestamp) {
                        exitEditMode();
                      }
                      loadReport(false);
                    } else {
                      setReportStatus(
                        resp && resp.message ? resp.message : "ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„.",
                        "error"
                      );
                    }
                  } catch (err) {
                    console.error(err);
                    setReportStatus("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù.", "error");
                  }
                });
              }
            }

            frag.appendChild(tr);
          });
          reportTableBody.appendChild(frag);
        }

        const totalForPct = total || rows.length || 0;

        if (!byExecutor.length) {
          byExecutorBox.innerHTML = '<p class="small-note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹ Ù…ØªØ§Ø­.</p>';
        } else {
          const fragExec = document.createDocumentFragment();
          byExecutor.forEach(function(item) {
            const count = item.count || 0;
            const pct = typeof item.percentFrom100 === "number"
              ? item.percentFrom100
              : (totalForPct ? (count * 100) / totalForPct : 0);

            const div = document.createElement("div");
            div.className = "summary-row";
            div.innerHTML =
              '<span class="summary-name">' + item.name + '</span>' +
              '<span>' +
              '<span class="summary-count">' + count + '</span> ' +
              '<span class="summary-percent">(' + pct.toFixed(1) + '%)</span>' +
              '</span>';
            fragExec.appendChild(div);
          });
          byExecutorBox.appendChild(fragExec);
        }

        if (!byType.length) {
          byTypeBox.innerHTML = '<p class="small-note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹ Ù…ØªØ§Ø­.</p>';
        } else {
          const fragType = document.createDocumentFragment();
          byType.forEach(function(item) {
            const count = item.count || 0;
            const pct = typeof item.percentFrom100 === "number"
              ? item.percentFrom100
              : (totalForPct ? (count * 100) / totalForPct : 0);

            const div = document.createElement("div");
            div.className = "summary-row";
            div.innerHTML =
              '<span class="summary-name">' + item.type + '</span>' +
              '<span>' +
              '<span class="summary-count">' + count + '</span> ' +
              '<span class="summary-percent">(' + pct.toFixed(1) + '%)</span>' +
              '</span>';
            fragType.appendChild(div);
          });
          byTypeBox.appendChild(fragType);
        }

        setReportStatus("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­. Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: " + total, "ok");
      } catch (err) {
        console.error(err);
        setReportStatus("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· API.", "error");
      }
    }

    btnLoadReport.addEventListener("click", function() { loadReport(true); });

    btnClearFilters.addEventListener("click", function() {
      filterMonth.value      = "";
      filterStore.value      = "";
      filterErrorType.value  = "";
      filterExecutor.value   = "";
      filterRecordedBy.value = "";
      loadReport(true);
    });

    window.addEventListener("DOMContentLoaded", function() {
      const u = loadUserFromStorage();
      if (!u) return;

      if (!hasRole("SUPPORT") && !hasRole("ADMIN") && !hasRole("AUDITOR_EXTENDED")) {
        window.location.href = "employee.html";
        return;
      }

      if (empInfo && (u.employeeCode || u.name)) {
        let txt = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ";
        if (u.employeeCode) txt += u.employeeCode + " - ";
        if (u.name) txt += u.name;
        txt += " (" + (u.role || "") + ")";
        empInfo.textContent = txt;
      }

      const recInput = document.getElementById("recordedBy");
      if (recInput && (u.employeeCode || u.name)) {
        let v = "";
        if (u.employeeCode) v += u.employeeCode;
        if (u.employeeCode && u.name) v += " - ";
        if (u.name) v += u.name;
        recInput.value = v;
        recInput.readOnly = true;
      }

      const now = new Date();
      const y   = now.getFullYear();
      const m   = String(now.getMonth() + 1).padStart(2, "0");
      filterMonth.value = y + "-" + m;

      renderNav("support.html");
      loadReport(false);
    });
  </script>
</body>
</html>
