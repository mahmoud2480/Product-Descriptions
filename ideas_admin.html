<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:"Cairo",system-ui,sans-serif; background:#f4f7fb; }
    header {
      background:#0d6efd; color:#fff; padding:10px 16px;
      display:flex; flex-direction:column; gap:8px;
    }
    .header-top {
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:1.1rem; }
    header a{color:#fff;}

    .nav-buttons {
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .nav-buttons button {
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.7);
      background:rgba(255,255,255,0.1);
      color:#fff;
      font-family:"Cairo",system-ui,sans-serif;
      font-size:0.8rem;
      cursor:pointer;
    }
    .nav-buttons button:hover {
      background:rgba(255,255,255,0.25);
    }
    .nav-buttons button.active {
      background:#fff;
      color:#0d6efd;
    }

    .layout {
      display:grid; grid-template-columns: 1.5fr 1.2fr; gap:10px; padding:10px;
    }
    @media (max-width:900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background:#fff; border-radius:14px; padding:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    h2 { margin:0 0 8px; font-size:1rem; }

    table { width:100%; border-collapse:collapse; font-size:0.8rem; }
    th, td {
      border:1px solid #eee; padding:4px 6px; text-align:center;
    }
    th { background:#f1f3f7; }
    tr:hover { background:#f9fafc; cursor:pointer; }

    .filters {
      display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px;
      font-size:0.8rem;
    }
    .filters label { font-size:0.75rem; color:#4b5563; }
    .filters select {
      padding:4px 6px;
      border-radius:8px;
      border:1px solid #ddd;
      font-family:inherit;
      font-size:0.8rem;
    }

    label { display:block; margin-top:6px; font-size:0.85rem; }
    textarea, input, select {
      width:100%; border-radius:10px;
      border:1px solid #ddd; font-family:inherit; font-size:0.9rem;
      padding:6px 8px; box-sizing:border-box;
    }
    textarea { min-height:100px; }

    button {
      margin-top:8px; padding:7px 12px; border-radius:10px;
      border:none; background:#0d6efd; color:#fff;
      font-family:inherit; font-size:0.9rem; cursor:pointer;
    }
    button.danger {
      background:#dc2626;
    }

    .msg { margin-top:4px; font-size:0.8rem; }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
      <div>
        <span id="adminName"></span> |
        <a href="#" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </header>

  <div class="layout">
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙÙƒØ§Ø± -->
    <div class="card">
      <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±</h2>
      <div class="filters">
        <div>
          <label>Ø§Ù„Ø´Ù‡Ø±</label><br/>
          <select id="filterMonth" onchange="loadIdeas()"></select>
        </div>
        <div>
          <label>Ø§Ù„Ù…ÙˆØ¸Ù</label><br/>
          <select id="filterEmployee" onchange="loadIdeas()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label><br/>
          <select id="filterStatus" onchange="loadIdeas()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
            <option value="Ù…Ø¹ØªÙ…Ø¯">Ù…Ø¹ØªÙ…Ø¯</option>
            <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
          </select>
        </div>
      </div>

      <div style="max-height:calc(100vh - 190px);overflow-y:auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„ÙÙƒØ±Ø©</th>
              <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody id="ideasBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙƒØ±Ø© -->
    <div class="card">
      <h2>ØªÙØ§ØµÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙƒØ±Ø©</h2>
      <div id="ideaDetails">
        Ø§Ø®ØªØ± ÙÙƒØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.
      </div>
    </div>
  </div>

  <!-- âœ… Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ -->
  <script src="config.js"></script>

  <script>
    // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API Ù…Ù† config.js
    const API_URL = window.API_URL;

    // âœ… Ø¯Ø§Ù„Ø© API Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø±Ø¯ ØºÙŠØ± JSON
    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload })
      });

      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error("API raw response (not JSON):", text);
        throw new Error("API response is not valid JSON");
      }
    }

    let user = null;
    let allIdeas = [];
    let currentIdeaId = null;

    function logout() {
      localStorage.removeItem("taskUser");
      window.location.href = "index.html";
    }

    function hasRole(code) {
      if (!user || !user.role) return false;
      const rolesText = user.role.toString().toUpperCase();
      return rolesText.includes(code);
    }

    function renderNav(activeHref) {
      const container = document.getElementById("navButtons");
      if (!container) return;
      container.innerHTML = "";

const links = [
  { code: "EMP",              label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù",   href: "employee.html" },
  { code: "EMP",              label: "Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù",   href: "ideas.html" },
  { code: "AUDITOR_EXTENDED", label: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ù‚Ù‚",    href: "auditor.html" },
  { code: "EVALUATOR",        label: "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",  href: "evaluator.html" },
  { code: "ADMIN",            label: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",   href: "admin.html" },
  { code: "ADMIN",            label: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±",  href: "ideas_admin.html" },

  // ğŸ”¥ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
  { code: "AUDITOR_EXTENDED", label: "ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©", href: "reports.html" }
];


      links.forEach(item => {
        if (!hasRole(item.code)) return;
        const btn = document.createElement("button");
        btn.textContent = item.label;
        if (activeHref === item.href) btn.classList.add("active");
        btn.onclick = () => {
          if (!window.location.pathname.endsWith(item.href)) {
            window.location.href = item.href;
          }
        };
        container.appendChild(btn);
      });
    }

    function initMonthFilter() {
      const sel = document.getElementById("filterMonth");
      if (!sel) return;
      const now = new Date();
      for (let i = 0; i < 6; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const y = d.getFullYear();
        const m = ("0" + (d.getMonth() + 1)).slice(-2);
        const key = y + "-" + m;
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        sel.appendChild(opt);
      }
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±";
      sel.insertBefore(allOpt, sel.firstChild);
      sel.value = "";
    }

    function loadUser() {
      const str = localStorage.getItem("taskUser");
      if (!str) {
        window.location.href = "index.html";
        return;
      }
      user = JSON.parse(str);
      if (!hasRole("ADMIN")) {
        window.location.href = "employee.html";
        return;
      }
      document.getElementById("adminName").textContent =
        user.name + " (" + user.role + ")";
      renderNav("ideas_admin.html");
      initMonthFilter();
      loadIdeas();
    }

    async function loadIdeas() {
      const tbody = document.getElementById("ideasBody");
      if (!tbody) return;
      tbody.innerHTML = "<tr><td colspan='6'>...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>";

      const monthSel = document.getElementById("filterMonth");
      const statusSel = document.getElementById("filterStatus");
      const empSel = document.getElementById("filterEmployee");

      const monthKey = monthSel ? (monthSel.value || null) : null;
      const status = statusSel ? (statusSel.value || null) : null;
      const empCode = empSel ? (empSel.value || null) : null;

      try {
        const res = await callApi("listIdeas", {
          filters: {
            employeeCode: empCode,
            monthKey: monthKey,
            status: status
          }
        });

        const list = Array.isArray(res)
          ? res
          : (res && res.ideas) || [];

        allIdeas = list;
        buildEmployeeFilter();
        renderIdeasTable();
      } catch (err) {
        console.error(err);
        tbody.innerHTML = "<tr><td colspan='6'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
      }
    }

    function buildEmployeeFilter() {
      const sel = document.getElementById("filterEmployee");
      if (!sel) return;
      const oldVal = sel.value;
      const set = new Set();
      allIdeas.forEach(i => {
        if (i.EmployeeCode) {
          set.add(i.EmployeeName + "|" + i.EmployeeCode);
        }
      });
      sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
      set.forEach(v => {
        const [name, code] = v.split("|");
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = name + " (" + code + ")";
        sel.appendChild(opt);
      });
      if ([...set].some(v => v.split("|")[1] === oldVal)) {
        sel.value = oldVal;
      }
    }

    function renderIdeasTable() {
      const tbody = document.getElementById("ideasBody");
      if (!tbody) return;
      if (!allIdeas.length) {
        tbody.innerHTML = "<tr><td colspan='6'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙÙƒØ§Ø±</td></tr>";
        document.getElementById("ideaDetails").textContent =
          "Ø§Ø®ØªØ± ÙÙƒØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.";
        return;
      }

      tbody.innerHTML = "";
      allIdeas.forEach(idea => {
        const tr = document.createElement("tr");
        const d = idea.Date
          ? new Date(idea.Date).toLocaleDateString("ar-SY")
          : "";
        tr.innerHTML = `
          <td>${idea.IdeaID}</td>
          <td>${d}</td>
          <td>${idea.EmployeeName || ""} (${idea.EmployeeCode || ""})</td>
          <td style="text-align:right;">${idea.IdeaText || ""}</td>
          <td>${idea.Points || 0}</td>
          <td>${idea.Status || "Ø¬Ø¯ÙŠØ¯"}</td>
        `;
        tr.onclick = () => showIdeaDetails(idea.IdeaID);
        tbody.appendChild(tr);
      });
    }

    function showIdeaDetails(ideaId) {
      currentIdeaId = ideaId;
      const idea = allIdeas.find(i => i.IdeaID == ideaId);
      const container = document.getElementById("ideaDetails");
      if (!container) return;
      if (!idea) {
        container.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙÙƒØ±Ø©.";
        return;
      }
      const d = idea.Date
        ? new Date(idea.Date).toLocaleString("ar-SY")
        : "";

      container.innerHTML = `
        <div><strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${idea.EmployeeName || ""} (${idea.EmployeeCode || ""})</div>
        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${d}</div>
        <label>Ù†Øµ Ø§Ù„ÙÙƒØ±Ø©</label>
        <textarea readonly>${idea.IdeaText || ""}</textarea>

        <label>Ø§Ù„Ù†Ù‚Ø§Ø·</label>
        <input type="number" id="ideaPoints" value="${idea.Points || 0}" min="0" step="1" />

        <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="ideaStatus">
          <option value="Ø¬Ø¯ÙŠØ¯"${idea.Status === "Ø¬Ø¯ÙŠØ¯" ? " selected" : ""}>Ø¬Ø¯ÙŠØ¯</option>
          <option value="Ù…Ø¹ØªÙ…Ø¯"${idea.Status === "Ù…Ø¹ØªÙ…Ø¯" ? " selected" : ""}>Ù…Ø¹ØªÙ…Ø¯</option>
          <option value="Ù…Ø±ÙÙˆØ¶"${idea.Status === "Ù…Ø±ÙÙˆØ¶" ? " selected" : ""}>Ù…Ø±ÙÙˆØ¶</option>
        </select>

        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
        <textarea id="ideaAdminNotes">${idea.AdminNotes || ""}</textarea>

        <button onclick="saveIdea()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="danger" onclick="deleteIdeaClick()">Ø­Ø°Ù Ø§Ù„ÙÙƒØ±Ø©</button>
        <div class="msg" id="ideaMsg"></div>
      `;
    }

    async function saveIdea() {
      const msg = document.getElementById("ideaMsg");
      if (!msg) return;
      msg.style.color = "#374151";
      msg.textContent = "...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸";

      const pts = Number(document.getElementById("ideaPoints").value || 0);
      const status = document.getElementById("ideaStatus").value;
      const notes = document.getElementById("ideaAdminNotes").value;

      try {
        const res = await callApi("updateIdea", {
          ideaId: currentIdeaId,
          points: pts,
          status: status,
          adminNotes: notes
        });
        if (res && res.success) {
          msg.style.color = "#16a34a";
          msg.textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.";
          loadIdeas();
        } else {
          msg.style.color = "#b91c1c";
          msg.textContent = "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.";
        }
      } catch (err) {
        console.error(err);
        msg.style.color = "#b91c1c";
        msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.";
      }
    }

    async function deleteIdeaClick() {
      const msg = document.getElementById("ideaMsg");
      if (!msg) return;
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙÙƒØ±Ø©ØŸ")) return;

      msg.style.color = "#374151";
      msg.textContent = "...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù";

      try {
        const res = await callApi("deleteIdea", { ideaId: currentIdeaId });
        if (res && res.success) {
          msg.style.color = "#16a34a";
          msg.textContent = "ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙƒØ±Ø©.";
          loadIdeas();
        } else {
          msg.style.color = "#b91c1c";
          msg.textContent = "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.";
        }
      } catch (err) {
        console.error(err);
        msg.style.color = "#b91c1c";
        msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.";
      }
    }

    document.addEventListener("DOMContentLoaded", loadUser);
  </script>
</body>
</html>
